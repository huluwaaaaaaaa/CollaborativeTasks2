# ============================================
# CollaborativeTasks2 Docker Compose配置
# 从Nexus私服拉取镜像版本
# 
# 前提条件：
# 1. MySQL已在本机运行（localhost:3306）
# 2. Redis已在Docker中运行
# 3. Nacos已在本机运行（localhost:8848）
# ============================================

services:
  # API服务（从Nexus拉取）
  collabtask-api:
    image: ${NEXUS_REGISTRY:-localhost:5000}/collabtask-api:${IMAGE_TAG:-latest}
    container_name: collabtask-api
    environment:
      # 动态环境配置（通过DEPLOY_ENV变量指定）
      SPRING_PROFILES_ACTIVE: ${DEPLOY_ENV:-test}  # 默认test，可覆盖
      NACOS_HOST: host.docker.internal
      NACOS_PORT: 8848
      NACOS_NAMESPACE: ${DEPLOY_ENV:-test}  # namespace跟随环境
      NACOS_USERNAME: nacos
      NACOS_PASSWORD: nacos
      # 覆盖Nacos配置（双保险）
      SPRING_DATASOURCE_URL: jdbc:mysql://host.docker.internal:3306/collabtask?useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai&nullCatalogMeansCurrent=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: Y9!8nIeRH@163
      SPRING_REDIS_HOST: host.docker.internal
      SPRING_REDIS_PORT: 6379
      JAVA_OPTS: -Xms512m -Xmx1024m
      TZ: Asia/Shanghai
    ports:
      - "8002:8002"
    volumes:
      - api-logs:/app/logs
    extra_hosts:
      # 允许容器访问宿主机服务
      - "host.docker.internal:host-gateway"
    networks:
      - collabtask-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/collabtask-api/"]
      interval: 30s
      timeout: 5s
      retries: 10
      start_period: 60s

  # Gateway网关（从Nexus拉取）
  collabtask-gateway:
    image: ${NEXUS_REGISTRY:-localhost:5000}/collabtask-gateway:${IMAGE_TAG:-latest}
    container_name: collabtask-gateway
    environment:
      # 动态环境配置
      SPRING_PROFILES_ACTIVE: ${DEPLOY_ENV:-test}  # 默认test，可覆盖
      NACOS_HOST: host.docker.internal
      NACOS_PORT: 8848
      NACOS_NAMESPACE: ${DEPLOY_ENV:-test}  # namespace跟随环境
      NACOS_USERNAME: nacos
      NACOS_PASSWORD: nacos
      JAVA_OPTS: -Xms256m -Xmx512m
      TZ: Asia/Shanghai
    ports:
      - "8001:8001"
    volumes:
      - gateway-logs:/app/logs
    extra_hosts:
      # 允许容器访问宿主机服务
      - "host.docker.internal:host-gateway"
    depends_on:
      - collabtask-api
    networks:
      - collabtask-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/"]
      interval: 30s
      timeout: 5s
      retries: 10
      start_period: 60s

# 网络配置
networks:
  collabtask-network:
    driver: bridge

# 数据卷
volumes:
  api-logs:
    driver: local
  gateway-logs:
    driver: local
