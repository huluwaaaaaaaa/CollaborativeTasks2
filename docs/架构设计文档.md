# CollaborativeTasks2 架构设计文档

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                       Client Layer                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Web Browser │  │  Mobile App  │  │   Postman    │      │
│  └───────┬──────┘  └───────┬──────┘  └───────┬──────┘      │
└──────────┼─────────────────┼─────────────────┼──────────────┘
           │                 │                 │
           └─────────────────┴─────────────────┘
                             │
                    ┌────────▼─────────┐
                    │  API Gateway     │
                    │  (Port: 8001)    │
                    │  ┌─────────────┐ │
                    │  │ - 路由转发  │ │
                    │  │ - 认证鉴权  │ │
                    │  │ - 负载均衡  │ │
                    │  │ - 跨域处理  │ │
                    │  └─────────────┘ │
                    └────────┬─────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
   ┌────▼──────┐       ┌────▼──────┐      ┌─────▼─────┐
   │   API     │       │   Admin   │      │  Future   │
   │  Service  │       │  Service  │      │  Services │
   │(Port:8002)│       │(Port:8003)│      │           │
   └────┬──────┘       └────┬──────┘      └───────────┘
        │                   │
        └─────────┬─────────┘
                  │
         ┌────────▼─────────┐
         │  Service Registry│
         │  & Config Center │
         │     (Nacos)      │
         │  (Port: 8848)    │
         └────────┬─────────┘
                  │
        ┌─────────┴──────────┐
        │                    │
   ┌────▼─────┐         ┌───▼────┐
   │  MySQL   │         │ Redis  │
   │(Port:3306)│       │(Port:6379)│
   └──────────┘         └────────┘
```

## 技术架构

### 技术栈

#### 后端框架
- **Spring Boot 3.5.4** - 应用框架
- **Spring Cloud 2024.0.0** - 微服务框架
- **Spring Cloud Gateway** - API网关
- **Spring Cloud Alibaba 2023.0.3.2** - 阿里云微服务组件

#### 数据层
- **MySQL 8.0** - 关系数据库
- **MyBatis Plus 3.5.8** - ORM框架
- **Druid 1.2.23** - 数据库连接池
- **Redis 7** - 缓存

#### 服务治理
- **Nacos 2.4.2** - 服务注册与配置中心
- **Spring Cloud LoadBalancer** - 负载均衡

#### 其他
- **Knife4j 4.5.0** - API文档
- **Hutool 5.8.29** - 工具库
- **Logback** - 日志框架

### DevOps工具
- **Docker** - 容器化
- **Docker Compose** - 服务编排
- **GitHub Actions** - CI/CD
- **Maven 3.9** - 构建工具
- **Makefile** - 任务自动化

## 模块设计

### 1. collabtask-common（公共模块）
**职责**：
- 通用工具类
- 异常处理
- 统一返回结果
- 基础实体类

**主要类**：
- `Result.java` - 统一返回格式
- `RenException.java` - 业务异常
- `BaseService` - 基础服务

### 2. collabtask-dynamic-datasource（动态数据源）
**职责**：
- 多数据源支持
- 动态切换数据源
- 数据源配置管理

**主要类**：
- `DynamicDataSource.java` - 动态数据源
- `DataSourceAspect.java` - AOP切面

### 3. collabtask-api（API服务）
**职责**：
- 用户管理
- TODO管理
- Token验证
- 业务逻辑处理

**端口**：8002
**Context-Path**：`/collabtask-api`

**主要功能**：
- 用户登录/注册
- TODO增删改查
- Token管理
- 权限验证

### 4. collabtask-gateway（API网关）
**职责**：
- 统一入口
- 路由转发
- Token认证
- 跨域处理
- 负载均衡

**端口**：8001

**主要功能**：
- 路由规则管理
- 全局认证过滤
- 请求日志记录
- CORS配置

### 5. collabtask-admin（管理后台，可选）
**职责**：
- 后台管理
- 系统配置
- 数据统计

**端口**：8003

## 设计模式与原则

### SOLID原则

#### 1. 单一职责原则 (SRP)
- ✅ Gateway只负责路由和认证
- ✅ API服务只负责业务逻辑
- ✅ 每个Service只处理一个领域

#### 2. 开闭原则 (OCP)
- ✅ 通过配置添加新路由，无需改代码
- ✅ 通过Nacos动态配置，支持扩展

#### 3. 里氏替换原则 (LSP)
- ✅ BaseService提供基础CRUD
- ✅ 子类可以安全替换

#### 4. 接口隔离原则 (ISP)
- ✅ Service接口职责单一
- ✅ DAO接口只定义数据访问

#### 5. 依赖倒置原则 (DIP)
- ✅ 依赖接口而非实现
- ✅ 使用Spring依赖注入

### 设计模式

| 模式 | 使用场景 | 实现 |
|------|---------|------|
| 策略模式 | 动态数据源切换 | `DynamicDataSource` |
| 过滤器模式 | Gateway认证 | `AuthGlobalFilter` |
| 模板方法 | BaseService | `BaseServiceImpl` |
| 工厂模式 | 数据源创建 | `DynamicDataSourceFactory` |
| 代理模式 | AOP切面 | Spring AOP |

## API设计

### RESTful规范

```
POST   /api/login          - 用户登录
POST   /api/logout         - 用户登出
POST   /api/register       - 用户注册

GET    /api/todos          - 获取TODO列表
POST   /api/todos          - 创建TODO
GET    /api/todos/{id}     - 获取TODO详情
PUT    /api/todos/{id}     - 更新TODO
DELETE /api/todos/{id}     - 删除TODO

GET    /api/todos?status=completed  - 按状态过滤
GET    /api/todos?sort=dueDate      - 按到期日期排序
```

### 统一返回格式

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "id": 1,
    "name": "TODO名称",
    "description": "描述",
    "dueDate": "2025-11-10",
    "status": "IN_PROGRESS"
  }
}
```

### 错误处理

```json
{
  "code": 401,
  "msg": "token无效或已过期",
  "data": null
}
```

## 数据模型

### TODO实体
```java
@TableName("tb_todo")
public class TodoEntity {
    private Long id;              // 唯一ID
    private String name;          // 名称
    private String description;   // 描述
    private Date dueDate;         // 到期日期
    private Integer status;       // 状态（0:未开始 1:进行中 2:已完成）
    private Integer priority;     // 优先级（1:低 2:中 3:高）
    private String tags;          // 标签（逗号分隔）
    private Long userId;          // 所属用户
    private Long teamId;          // 所属团队（团队功能）
    private Date createDate;      // 创建时间
    private Date updateDate;      // 更新时间
}
```

### User实体
```java
@TableName("tb_user")
public class UserEntity {
    private Long id;
    private String username;
    private String mobile;
    private String password;
    private Integer status;
    private Date createDate;
}
```

## 安全设计

### 认证流程

```
1. 用户登录 → API服务验证 → 返回Token
2. 后续请求 → Gateway拦截 → 验证Token → 转发
3. Token过期 → 返回401 → 前端跳转登录
```

### Token机制

- **生成**：UUID + 用户ID
- **存储**：MySQL（tb_token表）
- **传递**：HTTP Header `token`
- **有效期**：12小时（可配置）

### 权限控制

- `@Login` 注解标记需要登录的接口
- 拦截器验证token
- Gateway全局过滤

## 性能优化

### 1. 连接池配置
- **Druid连接池**：初始10，最大100
- **Redis连接池**：Lettuce连接池

### 2. 缓存策略
- Token缓存（Redis，可选）
- 用户信息缓存

### 3. 负载均衡
- **默认策略**：RoundRobin轮询
- **支持切换**：Random、WeightedResponse

### 4. 数据库优化
- 索引：mobile、status、userId
- 分页查询
- MyBatis Plus性能优化

## 扩展性设计

### 水平扩展

```bash
# 启动多个API实例
docker-compose up -d --scale collabtask-api=3

# Gateway自动负载均衡
```

### 服务扩展

添加新服务只需：
1. 注册到Nacos
2. 在Gateway添加路由规则
3. 无需修改现有服务

### 配置扩展

- 新增配置：在Nacos添加
- 动态刷新：`@RefreshScope`
- 无需重启服务

## 监控与运维

### 健康检查

```bash
# Gateway
curl http://localhost:8001/actuator/health

# API
curl http://localhost:8002/collabtask-api/actuator/health
```

### 日志管理

```
/app/logs/
├── api/
│   ├── api.log
│   └── error.log
└── gateway/
    ├── gateway.log
    └── error.log
```

### 指标监控（Actuator）

- `/actuator/health` - 健康状态
- `/actuator/metrics` - 性能指标
- `/actuator/env` - 环境信息

## 部署方案

### 开发环境
- **方式**：本地IDEA启动
- **配置**：本地+Nacos
- **数据库**：本地MySQL

### 测试环境
- **方式**：Docker Compose
- **配置**：Nacos (test命名空间)
- **数据库**：Docker MySQL

### 生产环境（建议）
- **方式**：Kubernetes
- **配置**：Nacos (prod命名空间)
- **数据库**：云数据库RDS
- **CI/CD**：GitHub Actions + K8s

## 优势亮点

### 1. 微服务架构
- ✅ 服务独立部署
- ✅ 技术栈灵活
- ✅ 故障隔离

### 2. 配置中心
- ✅ 集中管理配置
- ✅ 动态刷新
- ✅ 环境隔离

### 3. API网关
- ✅ 统一入口
- ✅ 认证鉴权
- ✅ 流量控制

### 4. DevOps
- ✅ Docker容器化
- ✅ 一键部署
- ✅ CI/CD自动化

### 5. 代码质量
- ✅ 分层清晰
- ✅ SOLID原则
- ✅ 设计模式
- ✅ 文档完善

## 面试演示要点

### 1. 架构设计
- 展示架构图
- 说明各层职责
- 解释技术选型

### 2. 核心功能
- TODO的CRUD
- 过滤和排序
- 用户认证

### 3. 代码质量
- SOLID原则应用
- 设计模式使用
- 异常处理

### 4. DevOps能力
- Docker一键部署
- CI/CD流程
- 配置管理

### 5. API设计
- RESTful规范
- 统一返回格式
- Swagger文档

## 进一步改进方向

### 短期（面试前）
1. ✅ 完善Docker部署
2. ✅ 完善文档
3. ⬜ 准备演示数据
4. ⬜ Postman测试集合
5. ⬜ 单元测试覆盖

### 中期（如果有时间）
1. ⬜ 团队功能
2. ⬜ 实时协作
3. ⬜ 更多的TODO属性
4. ⬜ Kubernetes部署

### 长期
1. ⬜ 前端界面
2. ⬜ 消息队列
3. ⬜ 分布式事务
4. ⬜ 监控告警

---

**本项目展示了完整的微服务架构和DevOps能力！** 🚀

