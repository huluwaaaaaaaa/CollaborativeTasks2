# ============================================
# æœ¬æœºGitLab CI/CDé…ç½®
# è§¦å‘æ¡ä»¶ï¼š
# 1. ä»»ä½•åˆ†æ”¯åˆå¹¶åˆ°teståˆ†æ”¯ -> è‡ªåŠ¨å‘ç‰ˆåˆ°æµ‹è¯•ç¯å¢ƒ
# 2. teståˆ†æ”¯åˆå¹¶åˆ°mainåˆ†æ”¯ -> è‡ªåŠ¨å‘ç‰ˆåˆ°ç”Ÿäº§ç¯å¢ƒ
# ============================================

variables:
  GIT_STRATEGY: clone

stages:
  - release

# ============================================
# æµ‹è¯•ç¯å¢ƒå‘ç‰ˆ
# è§¦å‘æ¡ä»¶ï¼šä»£ç åˆå¹¶åˆ°teståˆ†æ”¯ï¼ˆMerge Requestè¢«åˆå¹¶ï¼‰
# ============================================
release-test:
  stage: release
  tags:
    - local  # ä½¿ç”¨æœ¬åœ°Runner
  variables:
    ENV: "test"
  script:
    - echo "=========================================="
    - echo "ğŸš€ æµ‹è¯•ç¯å¢ƒè‡ªåŠ¨å‘ç‰ˆ"
    - echo "è§¦å‘åˆ†æ”¯: $CI_COMMIT_BRANCH"
    - echo "æäº¤ä¿¡æ¯: $CI_COMMIT_MESSAGE"
    - echo "=========================================="
    - cd /workspace  # è¿›å…¥æŒ‚è½½çš„é¡¹ç›®ç›®å½•
    - make release ENV=test
    - echo ""
    - echo "=========================================="
    - echo "âœ… æµ‹è¯•ç¯å¢ƒå‘ç‰ˆå®Œæˆï¼"
    - echo "è®¿é—®åœ°å€: http://localhost:8001"
    - echo "=========================================="
  rules:
    # è§„åˆ™1ï¼šä»£ç åˆå¹¶åˆ°teståˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
    - if: '$CI_COMMIT_BRANCH == "test" && $CI_PIPELINE_SOURCE == "push"'
      when: on_success
  environment:
    name: test
    url: http://localhost:8001

# ============================================
# ç”Ÿäº§ç¯å¢ƒå‘ç‰ˆ
# è§¦å‘æ¡ä»¶ï¼šteståˆ†æ”¯åˆå¹¶åˆ°mainåˆ†æ”¯ï¼ˆMerge Requestè¢«åˆå¹¶ï¼‰
# ============================================
release-prod:
  stage: release
  tags:
    - local
  variables:
    ENV: "prod"
  script:
    - echo "=========================================="
    - echo "ğŸš€ ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨å‘ç‰ˆ"
    - echo "è§¦å‘åˆ†æ”¯: $CI_COMMIT_BRANCH"
    - echo "æäº¤ä¿¡æ¯: $CI_COMMIT_MESSAGE"
    - echo "=========================================="
    - cd /workspace
    - make release ENV=prod
    - echo ""
    - echo "=========================================="
    - echo "âœ… ç”Ÿäº§ç¯å¢ƒå‘ç‰ˆå®Œæˆï¼"
    - echo "è®¿é—®åœ°å€: http://localhost:8001"
    - echo "=========================================="
  rules:
    # è§„åˆ™1ï¼šä»£ç åˆå¹¶åˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
      when: on_success
  environment:
    name: production
    url: http://localhost:8001

