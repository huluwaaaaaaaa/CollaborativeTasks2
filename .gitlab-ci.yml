# ============================================
# GitLab CI/CD é…ç½®
# è§¦å‘æ¡ä»¶ï¼šdevåˆå¹¶åˆ°teståˆ†æ”¯
# ============================================

variables:
  # ä½¿ç”¨å®¹å™¨åè®¿é—®Nexusï¼ˆå…³é”®ï¼ï¼‰
  NEXUS_REGISTRY: "collabtask-nexus:5000"
  NEXUS_USERNAME: "admin"
  NEXUS_PASSWORD: "123456"
  PROJECT_DIR: "/workspace"

stages:
  - deploy

# ============================================
# æµ‹è¯•ç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²
# ============================================
deploy-test:
  stage: deploy
  tags:
    - local
  variables:
    ENV: "test"
  script:
    - echo "=========================================="
    - echo "ğŸš€ æµ‹è¯•ç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²"
    - echo "=========================================="
    - echo "æäº¤åˆ†æ”¯:$CI_COMMIT_BRANCH"
    - echo "æäº¤ä½œè€…:$CI_COMMIT_AUTHOR"
    - echo "æäº¤SHA:$CI_COMMIT_SHORT_SHA"
    - echo "=========================================="
    - cd $PROJECT_DIR
    - echo "ğŸ” ç™»å½•Nexus..."
    - echo "$NEXUS_PASSWORD" | docker login $NEXUS_REGISTRY -u $NEXUS_USERNAME --password-stdin
    - echo "ğŸ“¦ å¼€å§‹æ„å»ºå’Œéƒ¨ç½²..."
    - make release ENV=$ENV NEXUS_REGISTRY=$NEXUS_REGISTRY
    - echo "=========================================="
    - echo "âœ… æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
    - echo "=========================================="
    - echo "ğŸŒ è®¿é—®:http://localhost:8001"
    - echo "ğŸ“Š æ—¥å¿—:docker logs -f collabtask-api"
    - echo "=========================================="
  rules:
    # å½“ä»£ç åˆå¹¶åˆ°teståˆ†æ”¯æ—¶è§¦å‘
    - if: '$CI_COMMIT_BRANCH == "test"'
      when: on_success
  environment:
    name: test
    url: http://localhost:8001
  timeout: 15m

# ============================================
# ç”Ÿäº§ç¯å¢ƒæ‰‹åŠ¨éƒ¨ç½²
# ============================================
deploy-prod:
  stage: deploy
  tags:
    - local
  variables:
    ENV: "prod"
  script:
    - echo "=========================================="
    - echo "ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²"
    - echo "=========================================="
    - cd $PROJECT_DIR
    - echo "$NEXUS_PASSWORD" | docker login $NEXUS_REGISTRY -u $NEXUS_USERNAME --password-stdin
    - make release ENV=$ENV NEXUS_REGISTRY=$NEXUS_REGISTRY
    - echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
  rules:
    # teståˆå¹¶åˆ°mainæ—¶ï¼Œéœ€è¦æ‰‹åŠ¨ç‚¹å‡»
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
  environment:
    name: production
    url: http://localhost:8001
  timeout: 15m
