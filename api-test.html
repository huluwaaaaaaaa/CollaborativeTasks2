<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CollabTask API æµ‹è¯•å¹³å° - v1.1 & v1.2 & v1.3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .header .info {
            color: #666;
            font-size: 14px;
        }
        
        .header .info .badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .auth-section {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .auth-section .token-display {
            background: white;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin-top: 10px;
        }
        
        .todo-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .todo-item {
            background: #f8fafc;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .todo-item.shared {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        
        .todo-item .todo-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .todo-item .todo-meta {
            font-size: 12px;
            color: #666;
        }
        
        .todo-item .todo-actions {
            margin-top: 8px;
        }
        
        .log-output {
            background: #1e293b;
            color: #10b981;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .log-output .log-success {
            color: #10b981;
        }
        
        .log-output .log-error {
            color: #ef4444;
        }
        
        .log-output .log-info {
            color: #3b82f6;
        }
        
        .badge-new {
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .scenario-btn {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ¯ CollabTask API æµ‹è¯•å¹³å°</h1>
            <div class="info">
                <strong>Gatewayåœ°å€ï¼š</strong>http://localhost:8001
                <span class="badge">v1.1 ACLæƒé™</span>
                <span class="badge">v1.2 å¹‚ç­‰æ€§</span>
                <span class="badge">v1.3 åˆ—è¡¨ä¼˜åŒ–</span>
            </div>
        </div>
        
        <div class="main-grid">
            <!-- 1. è®¤è¯ç®¡ç† -->
            <div class="card">
                <div class="card-title">ğŸ” 1. è®¤è¯ç®¡ç†</div>
                <div class="auth-section">
                    <div class="form-group">
                        <label>æ‰‹æœºå·</label>
                        <input type="text" id="mobile" value="13612345678">
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" id="password" value="admin">
                    </div>
                    <button class="btn btn-primary" onclick="login()">ç™»å½•</button>
                    <button class="btn btn-danger" onclick="logout()">ç™»å‡º</button>
                    
                    <div class="token-display" id="tokenDisplay">
                        Token: æœªç™»å½•
                    </div>
                </div>
            </div>
            
            <!-- 2. TODOç®¡ç† -->
            <div class="card">
                <div class="card-title">ğŸ“ 2. TODOç®¡ç†</div>
                <div class="form-group">
                    <label>TODO IDï¼ˆæ›´æ–°æ—¶å¡«å†™ï¼‰</label>
                    <input type="text" id="todoId" placeholder="é€‰æ‹©TODOè‡ªåŠ¨å¡«å……">
                </div>
                <div class="form-group">
                    <label>TODOåç§°</label>
                    <input type="text" id="todoName" placeholder="è¾“å…¥TODOåç§°">
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="todoDesc" placeholder="æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>
                <div class="form-group">
                    <label>ä¼˜å…ˆçº§</label>
                    <select id="todoPriority">
                        <option value="LOW">ä½</option>
                        <option value="MEDIUM">ä¸­</option>
                        <option value="HIGH" selected>é«˜</option>
                        <option value="URGENT">ç´§æ€¥</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="createTodo()">åˆ›å»ºTODO</button>
                <button class="btn btn-warning" onclick="updateTodo()">æ›´æ–°TODO</button>
                <button class="btn btn-success" onclick="getTodoList()">åˆ·æ–°åˆ—è¡¨</button>
            </div>
            
            <!-- 3. TODOåˆ—è¡¨ (v1.3ä¼˜åŒ–) -->
            <div class="card">
                <div class="card-title">
                    ğŸ“‹ 3. TODOåˆ—è¡¨
                    <span class="badge-new">v1.3</span>
                </div>
                
                <!-- é«˜çº§ç­›é€‰å’Œæ’åº -->
                <div style="background: #f8fafc; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px; font-weight: 600;">ğŸ” ç­›é€‰æ¡ä»¶</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 13px; margin-bottom: 10px;">
                        <select id="filterStatus" onchange="getTodoList()">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="NOT_STARTED">æœªå¼€å§‹</option>
                            <option value="IN_PROGRESS">è¿›è¡Œä¸­</option>
                            <option value="COMPLETED">å·²å®Œæˆ</option>
                        </select>
                        <select id="filterPriority" onchange="getTodoList()">
                            <option value="">å…¨éƒ¨ä¼˜å…ˆçº§</option>
                            <option value="LOW">ä½</option>
                            <option value="MEDIUM">ä¸­</option>
                            <option value="HIGH">é«˜</option>
                            <option value="URGENT">ç´§æ€¥</option>
                        </select>
                        <input type="text" id="filterKeyword" placeholder="æœç´¢å…³é”®è¯" onkeyup="getTodoList()" style="padding: 6px;">
                    </div>
                    
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px; font-weight: 600;">ğŸ“Š æ’åºæ–¹å¼</div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; font-size: 13px;">
                        <select id="orderBy" onchange="getTodoList()">
                            <option value="create_date">åˆ›å»ºæ—¶é—´</option>
                            <option value="due_date">æˆªæ­¢æ—¥æœŸ</option>
                            <option value="priority">ä¼˜å…ˆçº§</option>
                            <option value="status">çŠ¶æ€</option>
                        </select>
                        <select id="orderDirection" onchange="getTodoList()">
                            <option value="desc">é™åº â†“</option>
                            <option value="asc">å‡åº â†‘</option>
                        </select>
                    </div>
                </div>
                
                <div class="todo-list" id="todoList">
                    <p style="color: #999; text-align: center; padding: 20px;">è¯·å…ˆç™»å½•å¹¶åˆ·æ–°åˆ—è¡¨</p>
                </div>
            </div>
            
            <!-- 4. å›¢é˜Ÿç®¡ç† -->
            <div class="card">
                <div class="card-title">ğŸ‘¥ 4. å›¢é˜Ÿç®¡ç†</div>
                <div class="form-group">
                    <label>å›¢é˜ŸIDï¼ˆæ›´æ–°æ—¶å¡«å†™ï¼‰</label>
                    <input type="text" id="teamId" placeholder="é€‰æ‹©å›¢é˜Ÿè‡ªåŠ¨å¡«å……">
                </div>
                <div class="form-group">
                    <label>å›¢é˜Ÿåç§°</label>
                    <input type="text" id="teamName" placeholder="è¾“å…¥å›¢é˜Ÿåç§°">
                </div>
                <div class="form-group">
                    <label>å›¢é˜Ÿæè¿°</label>
                    <input type="text" id="teamDesc" placeholder="å›¢é˜Ÿæè¿°ï¼ˆå¯é€‰ï¼‰">
                </div>
                <button class="btn btn-primary" onclick="createTeam()">åˆ›å»ºå›¢é˜Ÿ</button>
                <button class="btn btn-warning" onclick="updateTeam()">æ›´æ–°å›¢é˜Ÿ</button>
                <button class="btn btn-success" onclick="getMyTeams()">æˆ‘çš„å›¢é˜Ÿ</button>
                
                <div id="teamList" style="margin-top: 15px; max-height: 200px; overflow-y: auto;">
                </div>
            </div>
            
            <!-- 4.5 å›¢é˜Ÿæˆå‘˜ç®¡ç† -->
            <div class="card">
                <div class="card-title">ğŸ‘¥ 4.5 å›¢é˜Ÿæˆå‘˜ç®¡ç†</div>
                <div class="form-group">
                    <label>å›¢é˜ŸID</label>
                    <input type="text" id="memberTeamId" placeholder="è¾“å…¥å›¢é˜ŸID">
                </div>
                <div class="form-group">
                    <label>æˆå‘˜ç”¨æˆ·ID</label>
                    <input type="text" id="memberId" placeholder="è¾“å…¥æˆå‘˜ID">
                </div>
                <button class="btn btn-primary" onclick="addTeamMember()">æ·»åŠ æˆå‘˜</button>
                <button class="btn btn-danger" onclick="removeTeamMember()">ç§»é™¤æˆå‘˜</button>
                
                <div id="teamMemberList" style="margin-top: 15px; max-height: 150px; overflow-y: auto;">
                </div>
            </div>
            
            <!-- 5. æ ‡ç­¾ç®¡ç† -->
            <div class="card">
                <div class="card-title">ğŸ·ï¸ 5. æ ‡ç­¾ç®¡ç†</div>
                <div class="form-group">
                    <label>æ ‡ç­¾IDï¼ˆæ›´æ–°æ—¶å¡«å†™ï¼‰</label>
                    <input type="text" id="tagId" placeholder="é€‰æ‹©æ ‡ç­¾è‡ªåŠ¨å¡«å……">
                </div>
                <div class="form-group">
                    <label>æ ‡ç­¾åç§°</label>
                    <input type="text" id="tagName" placeholder="è¾“å…¥æ ‡ç­¾åç§°">
                </div>
                <div class="form-group">
                    <label>æ ‡ç­¾é¢œè‰²</label>
                    <input type="color" id="tagColor" value="#667eea">
                </div>
                <button class="btn btn-primary" onclick="createTag()">åˆ›å»ºæ ‡ç­¾</button>
                <button class="btn btn-warning" onclick="updateTag()">æ›´æ–°æ ‡ç­¾</button>
                <button class="btn btn-success" onclick="getMyTags()">æˆ‘çš„æ ‡ç­¾</button>
                
                <div id="tagList" style="margin-top: 15px; max-height: 200px; overflow-y: auto;">
                </div>
            </div>
            
            <!-- 5.5 TODOæ ‡ç­¾å…³è” -->
            <div class="card">
                <div class="card-title">ğŸ”— 5.5 TODOæ ‡ç­¾å…³è”</div>
                <div class="form-group">
                    <label>TODO ID</label>
                    <input type="text" id="todoTagTodoId" placeholder="è¾“å…¥TODO ID">
                </div>
                <div class="form-group">
                    <label>æ ‡ç­¾ID</label>
                    <input type="text" id="todoTagTagId" placeholder="è¾“å…¥æ ‡ç­¾ID">
                </div>
                <button class="btn btn-primary" onclick="addTagToTodo()">æ·»åŠ æ ‡ç­¾</button>
                <button class="btn btn-danger" onclick="removeTagFromTodo()">ç§»é™¤æ ‡ç­¾</button>
                <button class="btn btn-success" onclick="getTodoTags()">æŸ¥çœ‹æ ‡ç­¾</button>
                
                <div id="todoTagList" style="margin-top: 15px; max-height: 150px; overflow-y: auto;">
                </div>
            </div>
            
            <!-- 6. TODOå…±äº« (v1.1) -->
            <div class="card">
                <div class="card-title">
                    ğŸ¤ 6. TODOå…±äº«
                    <span class="badge-new">v1.1</span>
                </div>
                <div class="form-group">
                    <label>TODO ID</label>
                    <input type="text" id="shareTodoId" placeholder="é€‰æ‹©æˆ–è¾“å…¥TODO ID">
                </div>
                <div class="form-group">
                    <label>ç›®æ ‡ç”¨æˆ·ID</label>
                    <input type="text" id="shareTargetUserId" placeholder="è¾“å…¥ç”¨æˆ·ID">
                </div>
                <div class="form-group">
                    <label>æƒé™ç±»å‹</label>
                    <select id="sharePermission">
                        <option value="VIEW">VIEW - ä»…æŸ¥çœ‹</option>
                        <option value="EDIT">EDIT - å¯ç¼–è¾‘</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="shareTodo()">å…±äº«TODO</button>
                <button class="btn btn-danger" onclick="unshareTodo()">å–æ¶ˆå…±äº«</button>
            </div>
            
            <!-- 7. æµ‹è¯•åœºæ™¯ -->
            <div class="card full-width">
                <div class="card-title">ğŸ§ª 7. è‡ªåŠ¨åŒ–æµ‹è¯•åœºæ™¯</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                    <button class="btn btn-primary scenario-btn" onclick="runFullScenario()">
                        å®Œæ•´åä½œæµç¨‹ï¼ˆ7æ­¥ï¼‰
                    </button>
                    <button class="btn btn-warning scenario-btn" onclick="testIdempotency()">
                        æµ‹è¯•å¹‚ç­‰æ€§ (v1.2)
                    </button>
                    <button class="btn btn-success scenario-btn" onclick="testSharedList()">
                        æµ‹è¯•å…±äº«åˆ—è¡¨ (v1.3)
                    </button>
                    <button class="btn btn-primary scenario-btn" onclick="testAllFeatures()">
                        æµ‹è¯•æ‰€æœ‰åŠŸèƒ½ï¼ˆå®Œæ•´ï¼‰
                    </button>
                    <button class="btn btn-danger scenario-btn" onclick="testNewFeatures()">
                        æµ‹è¯•æ–°å¢åŠŸèƒ½ï¼ˆæ ¸å¿ƒï¼‰âœ¨
                    </button>
                </div>
            </div>
            
            <!-- 8. æ—¥å¿—è¾“å‡º -->
            <div class="card full-width">
                <div class="card-title">ğŸ“Š 8. æµ‹è¯•æ—¥å¿—</div>
                <div class="log-output" id="logOutput">
                    <div class="log-info">>> æ¬¢è¿ä½¿ç”¨CollabTask APIæµ‹è¯•å¹³å°</div>
                    <div class="log-info">>> æ‰€æœ‰è¯·æ±‚é€šè¿‡Gateway: http://localhost:8001</div>
                    <div class="log-info">>> è¯·å…ˆç™»å½•ä»¥è·å–token</div>
                </div>
                <button class="btn btn-danger btn-sm" onclick="clearLog()" style="margin-top: 10px;">æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>
    </div>
    
    <script>
        // é…ç½®
        const API_BASE = 'http://localhost:8001';
        let token = '';
        let userId = '';
        let currentTodoId = '';
        
        // æ—¥å¿—è¾“å‡º
        function log(message, type = 'info') {
            const logDiv = document.getElementById('logOutput');
            const time = new Date().toLocaleTimeString();
            const className = `log-${type}`;
            logDiv.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logOutput').innerHTML = '';
        }
        
        // APIè¯·æ±‚å°è£…
        async function apiRequest(method, path, data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            if (token) {
                options.headers['token'] = token;
            }
            
            if (data && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`${API_BASE}${path}`, options);
                const result = await response.json();
                return result;
            } catch (error) {
                log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                return null;
            }
        }
        
        // 1. ç™»å½•
        async function login() {
            const mobile = document.getElementById('mobile').value;
            const password = document.getElementById('password').value;
            
            log(`ğŸ” ç™»å½•ä¸­... (${mobile})`);
            
            const result = await apiRequest('POST', '/api/login', { mobile, password });
            
            if (result && result.code === 0) {
                token = result.data.token;
                userId = result.data.userId;
                
                document.getElementById('tokenDisplay').innerHTML = 
                    `<strong>Token:</strong> ${token.substring(0, 30)}...<br>` +
                    `<strong>ç”¨æˆ·ID:</strong> ${userId}`;
                
                log(`âœ… ç™»å½•æˆåŠŸï¼ç”¨æˆ·ID: ${userId}`, 'success');
                log(`   Token: ${token.substring(0, 40)}...`, 'success');
            } else {
                log(`âŒ ç™»å½•å¤±è´¥: ${result?.msg || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            }
        }
        
        // 2. ç™»å‡º
        async function logout() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            log('ğŸšª ç™»å‡ºä¸­...');
            const result = await apiRequest('POST', '/api/logout');
            
            if (result && result.code === 0) {
                token = '';
                userId = '';
                document.getElementById('tokenDisplay').innerHTML = 'Token: æœªç™»å½•';
                log('âœ… ç™»å‡ºæˆåŠŸ', 'success');
            }
        }
        
        // 3. åˆ›å»ºTODO
        async function createTodo() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const name = document.getElementById('todoName').value;
            const description = document.getElementById('todoDesc').value;
            const priority = document.getElementById('todoPriority').value;
            
            if (!name) {
                log('âš ï¸ è¯·è¾“å…¥TODOåç§°', 'error');
                return;
            }
            
            log(`ğŸ“ åˆ›å»ºTODO: ${name}`);
            
            const result = await apiRequest('POST', '/api/todos', {
                name,
                description,
                priority
            });
            
            if (result && result.code === 0) {
                currentTodoId = result.data.id;
                document.getElementById('todoId').value = currentTodoId;
                document.getElementById('shareTodoId').value = currentTodoId;
                document.getElementById('todoTagTodoId').value = currentTodoId;
                
                log(`âœ… TODOåˆ›å»ºæˆåŠŸï¼ID: ${currentTodoId}`, 'success');
                log(`   çŠ¶æ€: ${result.data.status}`, 'success');
                
                // è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨
                setTimeout(() => getTodoList(), 500);
            } else if (result && result.msg === 'è¯·å‹¿é‡å¤æäº¤') {
                log(`âš ï¸ v1.2å¹‚ç­‰æ€§æ§åˆ¶: ${result.msg}`, 'info');
            } else {
                log(`âŒ åˆ›å»ºå¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // 3.5 æ›´æ–°TODO
        async function updateTodo() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const todoId = document.getElementById('todoId').value;
            const name = document.getElementById('todoName').value;
            const description = document.getElementById('todoDesc').value;
            const priority = document.getElementById('todoPriority').value;
            
            if (!todoId) {
                log('âš ï¸ è¯·å…ˆé€‰æ‹©TODOæˆ–è¾“å…¥TODO ID', 'error');
                return;
            }
            
            log(`âœï¸ æ›´æ–°TODO: ${todoId}`);
            
            const result = await apiRequest('PUT', `/api/todos/${todoId}`, {
                name,
                description,
                priority
            });
            
            if (result && result.code === 0) {
                log(`âœ… TODOæ›´æ–°æˆåŠŸï¼`, 'success');
                log(`   ã€v1.1ã€‘ACLæƒé™æ£€æŸ¥é€šè¿‡`, 'info');
                
                // è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨
                setTimeout(() => getTodoList(), 500);
            } else {
                log(`âŒ æ›´æ–°å¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // 4. è·å–TODOåˆ—è¡¨ (v1.3ä¼˜åŒ– + æ’åºæ”¯æŒ)
        async function getTodoList() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            // è·å–ç­›é€‰å’Œæ’åºæ¡ä»¶
            const status = document.getElementById('filterStatus')?.value || '';
            const priority = document.getElementById('filterPriority')?.value || '';
            const keyword = document.getElementById('filterKeyword')?.value || '';
            const orderBy = document.getElementById('orderBy')?.value || 'create_date';
            const orderDirection = document.getElementById('orderDirection')?.value || 'desc';
            
            // æ„å»ºæŸ¥è¯¢å‚æ•°
            let params = `page=1&limit=50`;
            if (status) params += `&status=${status}`;
            if (priority) params += `&priority=${priority}`;
            if (keyword) params += `&keyword=${encodeURIComponent(keyword)}`;
            params += `&orderBy=${orderBy}&orderDirection=${orderDirection}`;
            
            log(`ğŸ“‹ è·å–TODOåˆ—è¡¨ï¼ˆ${orderBy} ${orderDirection}ï¼‰...`);
            
            const result = await apiRequest('GET', `/api/todos?${params}`);
            
            if (result && result.code === 0) {
                const todos = result.data.list;
                const total = result.data.total;
                
                log(`âœ… è·å–æˆåŠŸï¼å…± ${total} ä¸ªTODO`, 'success');
                log(`   ã€v1.3ã€‘åŒ…å«: è‡ªå·±åˆ›å»ºçš„ + å…±äº«ç»™æˆ‘çš„`, 'info');
                log(`   æ’åº: ${getOrderByText(orderBy)} ${orderDirection === 'asc' ? 'â†‘' : 'â†“'}`, 'info');
                
                renderTodoList(todos);
            } else {
                log(`âŒ è·å–åˆ—è¡¨å¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // è·å–æ’åºå­—æ®µçš„ä¸­æ–‡åç§°
        function getOrderByText(orderBy) {
            const map = {
                'create_date': 'åˆ›å»ºæ—¶é—´',
                'due_date': 'æˆªæ­¢æ—¥æœŸ',
                'priority': 'ä¼˜å…ˆçº§',
                'status': 'çŠ¶æ€'
            };
            return map[orderBy] || orderBy;
        }
        
        // æ¸²æŸ“TODOåˆ—è¡¨
        function renderTodoList(todos) {
            const listDiv = document.getElementById('todoList');
            
            if (!todos || todos.length === 0) {
                listDiv.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— TODO</p>';
                return;
            }
            
            listDiv.innerHTML = todos.map(todo => {
                const isOwner = todo.userId === userId;
                const itemClass = isOwner ? 'todo-item' : 'todo-item shared';
                const ownerBadge = isOwner ? 'æˆ‘åˆ›å»ºçš„' : `<strong>å…±äº«çš„</strong> (æ¥è‡ª: ${todo.username})`;
                
                return `
                    <div class="${itemClass}">
                        <div class="todo-name">
                            ${todo.name}
                            <span style="font-size: 12px; color: #10b981;">${ownerBadge}</span>
                        </div>
                        <div class="todo-meta">
                            ID: ${todo.id} | 
                            çŠ¶æ€: ${todo.status} | 
                            ä¼˜å…ˆçº§: ${todo.priority}
                        </div>
                        <div class="todo-actions">
                            <button class="btn btn-sm btn-success" onclick="selectTodo('${todo.id}', '${todo.name}', '${todo.description || ''}', '${todo.priority}')">é€‰æ‹©</button>
                            <button class="btn btn-sm btn-primary" onclick="completeTodo('${todo.id}')">å®Œæˆ</button>
                            ${isOwner ? `<button class="btn btn-sm btn-danger" onclick="deleteTodo('${todo.id}')">åˆ é™¤</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // é€‰æ‹©TODOï¼ˆå¢å¼ºç‰ˆï¼‰
        function selectTodo(todoId, name, description, priority) {
            currentTodoId = todoId;
            document.getElementById('todoId').value = todoId;
            document.getElementById('shareTodoId').value = todoId;
            document.getElementById('todoTagTodoId').value = todoId;
            
            // å¡«å……ç¼–è¾‘è¡¨å•
            if (name) document.getElementById('todoName').value = name;
            if (description) document.getElementById('todoDesc').value = description;
            if (priority) document.getElementById('todoPriority').value = priority;
            
            log(`ğŸ“Œ å·²é€‰æ‹©TODO: ${todoId} - ${name || ''}`, 'info');
        }
        
        // å®ŒæˆTODO
        async function completeTodo(todoId) {
            if (!token) return;
            
            log(`âœ… æ ‡è®°TODOå®Œæˆ: ${todoId}`);
            const result = await apiRequest('PATCH', `/api/todos/${todoId}/complete`);
            
            if (result && result.code === 0) {
                log(`âœ… TODOå·²å®Œæˆï¼`, 'success');
                setTimeout(() => getTodoList(), 500);
            } else {
                log(`âŒ æ“ä½œå¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // åˆ é™¤TODO
        async function deleteTodo(todoId) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤TODOï¼Ÿ')) return;
            
            log(`ğŸ—‘ï¸ åˆ é™¤TODO: ${todoId}`);
            const result = await apiRequest('DELETE', `/api/todos/${todoId}`);
            
            if (result && result.code === 0) {
                log(`âœ… TODOå·²åˆ é™¤`, 'success');
                setTimeout(() => getTodoList(), 500);
            } else {
                log(`âŒ åˆ é™¤å¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // 5. å…±äº«TODO (v1.1)
        async function shareTodo() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const todoId = document.getElementById('shareTodoId').value;
            const targetUserId = document.getElementById('shareTargetUserId').value;
            const permission = document.getElementById('sharePermission').value;
            
            if (!todoId || !targetUserId) {
                log('âš ï¸ è¯·è¾“å…¥TODO IDå’Œç›®æ ‡ç”¨æˆ·ID', 'error');
                return;
            }
            
            log(`ğŸ¤ å…±äº«TODO ${todoId} ç»™ç”¨æˆ· ${targetUserId} (æƒé™: ${permission})`);
            
            const result = await apiRequest('POST', `/api/todos/${todoId}/share`, {
                targetUserId: parseInt(targetUserId),
                permission
            });
            
            if (result && result.code === 0) {
                log(`âœ… ã€v1.1ã€‘å…±äº«æˆåŠŸï¼`, 'success');
                log(`   ACLæƒé™å·²æˆäºˆ: ${permission}`, 'success');
            } else {
                log(`âŒ å…±äº«å¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // 6. å–æ¶ˆå…±äº«
        async function unshareTodo() {
            const todoId = document.getElementById('shareTodoId').value;
            const targetUserId = document.getElementById('shareTargetUserId').value;
            
            if (!todoId || !targetUserId) {
                log('âš ï¸ è¯·è¾“å…¥TODO IDå’Œç›®æ ‡ç”¨æˆ·ID', 'error');
                return;
            }
            
            log(`ğŸš« å–æ¶ˆå…±äº«TODO ${todoId}`);
            
            const result = await apiRequest('DELETE', `/api/todos/${todoId}/share/${targetUserId}`);
            
            if (result && result.code === 0) {
                log(`âœ… ã€v1.1ã€‘å–æ¶ˆå…±äº«æˆåŠŸï¼`, 'success');
            } else {
                log(`âŒ å–æ¶ˆå…±äº«å¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // 7. è¿è¡Œå®Œæ•´åä½œæµç¨‹
        async function runFullScenario() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            clearLog();
            log('========================================', 'info');
            log('ğŸ¯ å¼€å§‹æ‰§è¡Œå®Œæ•´åä½œæµç¨‹æµ‹è¯•', 'info');
            log('========================================', 'info');
            
            // Step 1: åˆ›å»ºTODO
            log('Step 1/7: åˆ›å»ºTODO...');
            let createResult = await apiRequest('POST', '/api/todos', {
                name: 'å®Œæ•´æµç¨‹æµ‹è¯•TODO',
                description: 'v1.1+v1.2+v1.3éªŒè¯',
                priority: 'HIGH'
            });
            
            let testTodoId;
            if (createResult && createResult.code === 0) {
                testTodoId = createResult.data.id;
                log(`âœ… åˆ›å»ºæˆåŠŸï¼ŒID: ${testTodoId}`, 'success');
            } else if (createResult && createResult.msg.includes('é‡å¤')) {
                log(`âœ… ã€v1.2ã€‘å¹‚ç­‰æ€§æ§åˆ¶ç”Ÿæ•ˆ`, 'success');
                testTodoId = currentTodoId || '10';
            } else {
                log(`âŒ åˆ›å»ºå¤±è´¥`, 'error');
                return;
            }
            
            await sleep(500);
            
            // Step 2: å…±äº«VIEWæƒé™
            log('Step 2/7: å…±äº«TODOï¼ˆVIEWæƒé™ï¼‰...');
            let shareResult = await apiRequest('POST', `/api/todos/${testTodoId}/share`, {
                targetUserId: 1067246875900000002,
                permission: 'VIEW'
            });
            
            if (shareResult && shareResult.code === 0) {
                log(`âœ… ã€v1.1ã€‘å…±äº«VIEWæƒé™æˆåŠŸ`, 'success');
            }
            
            await sleep(500);
            
            // Step 3: å‡çº§EDITæƒé™
            log('Step 3/7: å‡çº§ä¸ºEDITæƒé™...');
            let editResult = await apiRequest('POST', `/api/todos/${testTodoId}/share`, {
                targetUserId: 1067246875900000002,
                permission: 'EDIT'
            });
            
            if (editResult && editResult.code === 0) {
                log(`âœ… ã€v1.1ã€‘å‡çº§ä¸ºEDITæƒé™æˆåŠŸ`, 'success');
            }
            
            await sleep(500);
            
            // Step 4: æ›´æ–°TODO
            log('Step 4/7: æ›´æ–°TODOï¼ˆACLæƒé™æ£€æŸ¥ï¼‰...');
            let updateResult = await apiRequest('PUT', `/api/todos/${testTodoId}`, {
                name: 'âœ…å®Œæ•´æµç¨‹æµ‹è¯•é€šè¿‡'
            });
            
            if (updateResult && updateResult.code === 0) {
                log(`âœ… ã€v1.1ã€‘æ›´æ–°æˆåŠŸï¼ˆACLæ£€æŸ¥é€šè¿‡ï¼‰`, 'success');
            }
            
            await sleep(500);
            
            // Step 5: è·å–åˆ—è¡¨
            log('Step 5/7: è·å–TODOåˆ—è¡¨...');
            let listResult = await apiRequest('GET', '/api/todos?page=1&limit=50');
            
            if (listResult && listResult.code === 0) {
                log(`âœ… ã€v1.3ã€‘åˆ—è¡¨æŸ¥è¯¢æˆåŠŸï¼Œå…± ${listResult.data.total} ä¸ªTODO`, 'success');
                renderTodoList(listResult.data.list);
            }
            
            await sleep(500);
            
            // Step 6: å®ŒæˆTODO
            log('Step 6/7: æ ‡è®°TODOå®Œæˆ...');
            let completeResult = await apiRequest('PATCH', `/api/todos/${testTodoId}/complete`);
            
            if (completeResult && completeResult.code === 0) {
                log(`âœ… TODOå·²å®Œæˆ`, 'success');
            } else {
                log(`âš ï¸ ${completeResult?.msg || 'å·²å®Œæˆ'}`, 'info');
            }
            
            await sleep(500);
            
            // Step 7: å–æ¶ˆå…±äº«
            log('Step 7/7: å–æ¶ˆå…±äº«...');
            let unshareResult = await apiRequest('DELETE', `/api/todos/${testTodoId}/share/1067246875900000002`);
            
            if (unshareResult && unshareResult.code === 0) {
                log(`âœ… ã€v1.1ã€‘å–æ¶ˆå…±äº«æˆåŠŸ`, 'success');
            }
            
            log('========================================', 'success');
            log('ğŸ‰ å®Œæ•´åä½œæµç¨‹æµ‹è¯•å®Œæˆï¼', 'success');
            log('========================================', 'success');
            
            // åˆ·æ–°åˆ—è¡¨
            setTimeout(() => getTodoList(), 1000);
        }
        
        // 8. æµ‹è¯•å¹‚ç­‰æ€§
        async function testIdempotency() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            clearLog();
            log('========================================', 'info');
            log('ğŸ§ª v1.2 å¹‚ç­‰æ€§æ§åˆ¶æµ‹è¯•', 'info');
            log('========================================', 'info');
            
            const testData = {
                name: 'å¹‚ç­‰æ€§æµ‹è¯•TODO-' + Date.now(),
                priority: 'HIGH'
            };
            
            // ç¬¬1æ¬¡è¯·æ±‚
            log('å‘é€è¯·æ±‚1...');
            let result1 = await apiRequest('POST', '/api/todos', testData);
            
            if (result1 && result1.code === 0) {
                log(`âœ… è¯·æ±‚1æˆåŠŸï¼ŒID: ${result1.data.id}`, 'success');
            } else {
                log(`âš ï¸ è¯·æ±‚1: ${result1?.msg}`, 'info');
            }
            
            await sleep(100);
            
            // ç¬¬2æ¬¡è¯·æ±‚ï¼ˆç«‹å³ï¼‰
            log('å‘é€è¯·æ±‚2ï¼ˆç«‹å³é‡å¤ï¼‰...');
            let result2 = await apiRequest('POST', '/api/todos', testData);
            
            if (result2 && result2.msg && result2.msg.includes('é‡å¤')) {
                log(`âœ… ã€v1.2ã€‘å¹‚ç­‰æ€§æ§åˆ¶ç”Ÿæ•ˆï¼`, 'success');
                log(`   æ‹’ç»åŸå› : ${result2.msg}`, 'success');
            } else if (result2 && result2.code === 0) {
                log(`âŒ å¹‚ç­‰æ€§æœªç”Ÿæ•ˆï¼ˆä¸åº”åˆ›å»ºæˆåŠŸï¼‰`, 'error');
            }
            
            log('========================================', 'success');
            log('ğŸ‰ å¹‚ç­‰æ€§æµ‹è¯•å®Œæˆï¼', 'success');
        }
        
        // 9. æµ‹è¯•å…±äº«åˆ—è¡¨ (v1.3)
        async function testSharedList() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            clearLog();
            log('========================================', 'info');
            log('ğŸ§ª v1.3 å…±äº«TODOåˆ—è¡¨æµ‹è¯•', 'info');
            log('========================================', 'info');
            
            // è·å–å½“å‰åˆ—è¡¨
            log('Step 1: è·å–å½“å‰åˆ—è¡¨...');
            let list1 = await apiRequest('GET', '/api/todos?page=1&limit=50');
            let total1 = list1?.data?.total || 0;
            log(`   å½“å‰TODOæ€»æ•°: ${total1}`, 'info');
            
            await sleep(500);
            
            // åˆ›å»ºå¹¶å…±äº«
            log('Step 2: åˆ›å»ºTODOå¹¶å…±äº«...');
            let create = await apiRequest('POST', '/api/todos', {
                name: 'v1.3åˆ—è¡¨æµ‹è¯•TODO',
                priority: 'HIGH'
            });
            
            let testId;
            if (create && create.code === 0) {
                testId = create.data.id;
                log(`   âœ… åˆ›å»ºæˆåŠŸï¼ŒID: ${testId}`, 'success');
            } else if (create && create.msg.includes('é‡å¤')) {
                testId = currentTodoId || '13';
                log(`   â­ï¸ ä½¿ç”¨å·²æœ‰TODO: ${testId}`, 'info');
            }
            
            await sleep(500);
            
            // è·å–æ›´æ–°åçš„åˆ—è¡¨
            log('Step 3: è·å–æ›´æ–°åçš„åˆ—è¡¨...');
            let list2 = await apiRequest('GET', '/api/todos?page=1&limit=50');
            let total2 = list2?.data?.total || 0;
            
            log(`âœ… ã€v1.3ã€‘åˆ—è¡¨æŸ¥è¯¢æˆåŠŸ`, 'success');
            log(`   TODOæ€»æ•°: ${total2}`, 'success');
            log(`   åŒ…å«: è‡ªå·±åˆ›å»ºçš„ + å…±äº«ç»™æˆ‘çš„`, 'info');
            
            renderTodoList(list2?.data?.list || []);
            
            log('========================================', 'success');
            log('ğŸ‰ v1.3åˆ—è¡¨æµ‹è¯•å®Œæˆï¼', 'success');
        }
        
        // 10. åˆ›å»ºå›¢é˜Ÿ (v1.2å¹‚ç­‰æ€§)
        async function createTeam() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const name = document.getElementById('teamName').value;
            const description = document.getElementById('teamDesc').value;
            
            if (!name) {
                log('âš ï¸ è¯·è¾“å…¥å›¢é˜Ÿåç§°', 'error');
                return;
            }
            
            log(`ğŸ‘¥ åˆ›å»ºå›¢é˜Ÿ: ${name}`);
            
            const result = await apiRequest('POST', '/api/teams', {
                name,
                description
            });
            
            if (result && result.code === 0) {
                document.getElementById('teamId').value = result.data.id;
                document.getElementById('memberTeamId').value = result.data.id;
                log(`âœ… å›¢é˜Ÿåˆ›å»ºæˆåŠŸï¼ID: ${result.data.id}`, 'success');
                log(`   ã€v1.2ã€‘å¸¦å¹‚ç­‰æ€§æ§åˆ¶`, 'info');
                setTimeout(() => getMyTeams(), 500);
            } else if (result && result.msg.includes('é‡å¤')) {
                log(`âš ï¸ ã€v1.2ã€‘å¹‚ç­‰æ€§æ§åˆ¶: ${result.msg}`, 'info');
            } else {
                log(`âŒ åˆ›å»ºå¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // 10.5 æ›´æ–°å›¢é˜Ÿ
        async function updateTeam() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const teamId = document.getElementById('teamId').value;
            const name = document.getElementById('teamName').value;
            const description = document.getElementById('teamDesc').value;
            
            if (!teamId) {
                log('âš ï¸ è¯·è¾“å…¥å›¢é˜ŸID', 'error');
                return;
            }
            
            log(`âœï¸ æ›´æ–°å›¢é˜Ÿ: ${teamId}`);
            
            const result = await apiRequest('PUT', `/api/teams/${teamId}`, {
                name,
                description
            });
            
            if (result && result.code === 0) {
                log(`âœ… å›¢é˜Ÿæ›´æ–°æˆåŠŸï¼`, 'success');
                setTimeout(() => getMyTeams(), 500);
            } else {
                log(`âŒ æ›´æ–°å¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // 11. è·å–æˆ‘çš„å›¢é˜Ÿ
        async function getMyTeams() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            log('ğŸ‘¥ è·å–æˆ‘çš„å›¢é˜Ÿåˆ—è¡¨...');
            
            const result = await apiRequest('GET', '/api/teams');
            
            if (result && result.code === 0) {
                const teams = result.data;
                log(`âœ… è·å–æˆåŠŸï¼å…± ${teams.length} ä¸ªå›¢é˜Ÿ`, 'success');
                renderTeamList(teams);
            } else {
                log(`âŒ è·å–å¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // æ¸²æŸ“å›¢é˜Ÿåˆ—è¡¨
        function renderTeamList(teams) {
            const listDiv = document.getElementById('teamList');
            
            if (!teams || teams.length === 0) {
                listDiv.innerHTML = '<p style="color: #999; font-size: 12px; padding: 10px;">æš‚æ— å›¢é˜Ÿ</p>';
                return;
            }
            
            listDiv.innerHTML = teams.map(team => `
                <div style="background: #f8fafc; padding: 10px; margin-bottom: 8px; border-radius: 6px; font-size: 13px;">
                    <strong>${team.name}</strong> (ID: ${team.id})<br>
                    <span style="color: #666;">æˆå‘˜: ${team.memberCount || 0} | æ‰€æœ‰è€…: ${team.ownerName || 'Me'}</span>
                    <div style="margin-top: 6px;">
                        <button class="btn btn-sm btn-primary" onclick="selectTeam('${team.id}', '${team.name}', '${team.description || ''}')">é€‰æ‹©</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTeam('${team.id}')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        // é€‰æ‹©å›¢é˜Ÿ
        function selectTeam(teamId, name, description) {
            document.getElementById('teamId').value = teamId;
            document.getElementById('memberTeamId').value = teamId;
            document.getElementById('teamName').value = name;
            document.getElementById('teamDesc').value = description;
            log(`ğŸ“Œ å·²é€‰æ‹©å›¢é˜Ÿ: ${teamId} - ${name}`, 'info');
        }
        
        // åˆ é™¤å›¢é˜Ÿ
        async function deleteTeam(teamId) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤å›¢é˜Ÿï¼Ÿ')) return;
            
            log(`ğŸ—‘ï¸ åˆ é™¤å›¢é˜Ÿ: ${teamId}`);
            const result = await apiRequest('DELETE', `/api/teams/${teamId}`);
            
            if (result && result.code === 0) {
                log(`âœ… å›¢é˜Ÿå·²åˆ é™¤`, 'success');
                setTimeout(() => getMyTeams(), 500);
            } else {
                log(`âŒ åˆ é™¤å¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // æ·»åŠ å›¢é˜Ÿæˆå‘˜
        async function addTeamMember() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const teamId = document.getElementById('memberTeamId').value;
            const memberId = document.getElementById('memberId').value;
            
            if (!teamId || !memberId) {
                log('âš ï¸ è¯·è¾“å…¥å›¢é˜ŸIDå’Œæˆå‘˜ID', 'error');
                return;
            }
            
            log(`ğŸ‘¥ æ·»åŠ æˆå‘˜ ${memberId} åˆ°å›¢é˜Ÿ ${teamId}`);
            
            const result = await apiRequest('POST', `/api/teams/${teamId}/members/${memberId}`);
            
            if (result && result.code === 0) {
                log(`âœ… æˆå‘˜æ·»åŠ æˆåŠŸï¼`, 'success');
                log(`   å›¢é˜Ÿåä½œåŠŸèƒ½å·²å¯ç”¨`, 'info');
            } else {
                log(`âŒ æ·»åŠ å¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // ç§»é™¤å›¢é˜Ÿæˆå‘˜
        async function removeTeamMember() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const teamId = document.getElementById('memberTeamId').value;
            const memberId = document.getElementById('memberId').value;
            
            if (!teamId || !memberId) {
                log('âš ï¸ è¯·è¾“å…¥å›¢é˜ŸIDå’Œæˆå‘˜ID', 'error');
                return;
            }
            
            log(`ğŸš« ä»å›¢é˜Ÿ ${teamId} ç§»é™¤æˆå‘˜ ${memberId}`);
            
            const result = await apiRequest('DELETE', `/api/teams/${teamId}/members/${memberId}`);
            
            if (result && result.code === 0) {
                log(`âœ… æˆå‘˜å·²ç§»é™¤`, 'success');
            } else {
                log(`âŒ ç§»é™¤å¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // 12. åˆ›å»ºæ ‡ç­¾ (v1.2å¹‚ç­‰æ€§)
        async function createTag() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const name = document.getElementById('tagName').value;
            const color = document.getElementById('tagColor').value;
            
            if (!name) {
                log('âš ï¸ è¯·è¾“å…¥æ ‡ç­¾åç§°', 'error');
                return;
            }
            
            log(`ğŸ·ï¸ åˆ›å»ºæ ‡ç­¾: ${name} (${color})`);
            
            const result = await apiRequest('POST', '/api/tags', {
                name,
                color
            });
            
            if (result && result.code === 0) {
                document.getElementById('tagId').value = result.data.id;
                document.getElementById('todoTagTagId').value = result.data.id;
                log(`âœ… æ ‡ç­¾åˆ›å»ºæˆåŠŸï¼ID: ${result.data.id}`, 'success');
                log(`   ã€v1.2ã€‘å¸¦å¹‚ç­‰æ€§æ§åˆ¶`, 'info');
                setTimeout(() => getMyTags(), 500);
            } else if (result && result.msg.includes('é‡å¤\|å·²å­˜åœ¨')) {
                log(`âš ï¸ ã€v1.2ã€‘å¹‚ç­‰æ€§æ§åˆ¶æˆ–æ ‡ç­¾å·²å­˜åœ¨: ${result.msg}`, 'info');
            } else {
                log(`âŒ åˆ›å»ºå¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // 12.5 æ›´æ–°æ ‡ç­¾
        async function updateTag() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const tagId = document.getElementById('tagId').value;
            const name = document.getElementById('tagName').value;
            const color = document.getElementById('tagColor').value;
            
            if (!tagId) {
                log('âš ï¸ è¯·è¾“å…¥æ ‡ç­¾ID', 'error');
                return;
            }
            
            log(`âœï¸ æ›´æ–°æ ‡ç­¾: ${tagId}`);
            
            const result = await apiRequest('PUT', `/api/tags/${tagId}`, {
                name,
                color
            });
            
            if (result && result.code === 0) {
                log(`âœ… æ ‡ç­¾æ›´æ–°æˆåŠŸï¼`, 'success');
                setTimeout(() => getMyTags(), 500);
            } else {
                log(`âŒ æ›´æ–°å¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // 13. è·å–æˆ‘çš„æ ‡ç­¾
        async function getMyTags() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            log('ğŸ·ï¸ è·å–æˆ‘çš„æ ‡ç­¾åˆ—è¡¨...');
            
            const result = await apiRequest('GET', '/api/tags');
            
            if (result && result.code === 0) {
                const tags = result.data;
                log(`âœ… è·å–æˆåŠŸï¼å…± ${tags.length} ä¸ªæ ‡ç­¾`, 'success');
                renderTagList(tags);
            } else {
                log(`âŒ è·å–å¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // æ¸²æŸ“æ ‡ç­¾åˆ—è¡¨
        function renderTagList(tags) {
            const listDiv = document.getElementById('tagList');
            
            if (!tags || tags.length === 0) {
                listDiv.innerHTML = '<p style="color: #999; font-size: 12px; padding: 10px;">æš‚æ— æ ‡ç­¾</p>';
                return;
            }
            
            listDiv.innerHTML = tags.map(tag => `
                <div style="background: #f8fafc; padding: 8px 12px; margin-bottom: 6px; border-radius: 6px; font-size: 13px; display: flex; align-items: center; gap: 10px; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="width: 20px; height: 20px; background: ${tag.color}; border-radius: 4px; display: inline-block;"></span>
                        <strong>${tag.name}</strong> 
                        <span style="color: #666; font-size: 12px;">(ID: ${tag.id})</span>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-primary" onclick="selectTag('${tag.id}', '${tag.name}', '${tag.color}')">é€‰æ‹©</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTag('${tag.id}')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        // é€‰æ‹©æ ‡ç­¾
        function selectTag(tagId, name, color) {
            document.getElementById('tagId').value = tagId;
            document.getElementById('todoTagTagId').value = tagId;
            document.getElementById('tagName').value = name;
            document.getElementById('tagColor').value = color;
            log(`ğŸ“Œ å·²é€‰æ‹©æ ‡ç­¾: ${tagId} - ${name}`, 'info');
        }
        
        // åˆ é™¤æ ‡ç­¾
        async function deleteTag(tagId) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤æ ‡ç­¾ï¼Ÿ')) return;
            
            log(`ğŸ—‘ï¸ åˆ é™¤æ ‡ç­¾: ${tagId}`);
            const result = await apiRequest('DELETE', `/api/tags/${tagId}`);
            
            if (result && result.code === 0) {
                log(`âœ… æ ‡ç­¾å·²åˆ é™¤`, 'success');
                setTimeout(() => getMyTags(), 500);
            } else {
                log(`âŒ åˆ é™¤å¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // ç»™TODOæ·»åŠ æ ‡ç­¾
        async function addTagToTodo() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const todoId = document.getElementById('todoTagTodoId').value;
            const tagId = document.getElementById('todoTagTagId').value;
            
            if (!todoId || !tagId) {
                log('âš ï¸ è¯·è¾“å…¥TODO IDå’Œæ ‡ç­¾ID', 'error');
                return;
            }
            
            log(`ğŸ”— ç»™TODO ${todoId} æ·»åŠ æ ‡ç­¾ ${tagId}`);
            
            const result = await apiRequest('POST', `/api/tags/todos/${todoId}/tags/${tagId}`);
            
            if (result && result.code === 0) {
                log(`âœ… æ ‡ç­¾æ·»åŠ æˆåŠŸï¼`, 'success');
                log(`   TODOæ ‡ç­¾å…³è”åŠŸèƒ½å·²å¯ç”¨`, 'info');
                setTimeout(() => getTodoTags(), 500);
            } else {
                log(`âŒ æ·»åŠ å¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // ä»TODOç§»é™¤æ ‡ç­¾
        async function removeTagFromTodo() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const todoId = document.getElementById('todoTagTodoId').value;
            const tagId = document.getElementById('todoTagTagId').value;
            
            if (!todoId || !tagId) {
                log('âš ï¸ è¯·è¾“å…¥TODO IDå’Œæ ‡ç­¾ID', 'error');
                return;
            }
            
            log(`ğŸš« ä»TODO ${todoId} ç§»é™¤æ ‡ç­¾ ${tagId}`);
            
            const result = await apiRequest('DELETE', `/api/tags/todos/${todoId}/tags/${tagId}`);
            
            if (result && result.code === 0) {
                log(`âœ… æ ‡ç­¾å·²ç§»é™¤`, 'success');
                setTimeout(() => getTodoTags(), 500);
            } else {
                log(`âŒ ç§»é™¤å¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // æŸ¥çœ‹TODOçš„æ ‡ç­¾
        async function getTodoTags() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const todoId = document.getElementById('todoTagTodoId').value;
            
            if (!todoId) {
                log('âš ï¸ è¯·è¾“å…¥TODO ID', 'error');
                return;
            }
            
            log(`ğŸ·ï¸ æŸ¥è¯¢TODO ${todoId} çš„æ ‡ç­¾...`);
            
            const result = await apiRequest('GET', `/api/tags/todos/${todoId}`);
            
            if (result && result.code === 0) {
                const tags = result.data;
                log(`âœ… æŸ¥è¯¢æˆåŠŸï¼å…± ${tags.length} ä¸ªæ ‡ç­¾`, 'success');
                renderTodoTags(tags);
            } else {
                log(`âŒ æŸ¥è¯¢å¤±è´¥: ${result?.msg}`, 'error');
            }
        }
        
        // æ¸²æŸ“TODOæ ‡ç­¾åˆ—è¡¨
        function renderTodoTags(tags) {
            const listDiv = document.getElementById('todoTagList');
            
            if (!tags || tags.length === 0) {
                listDiv.innerHTML = '<p style="color: #999; font-size: 12px; padding: 10px;">è¯¥TODOæš‚æ— æ ‡ç­¾</p>';
                return;
            }
            
            listDiv.innerHTML = tags.map(tag => `
                <div style="background: #f8fafc; padding: 6px 10px; margin-bottom: 4px; border-radius: 6px; font-size: 12px; display: flex; align-items: center; gap: 8px;">
                    <span style="width: 16px; height: 16px; background: ${tag.color}; border-radius: 3px; display: inline-block;"></span>
                    <strong>${tag.name}</strong>
                </div>
            `).join('');
        }
        
        // 14. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
        async function testAllFeatures() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            clearLog();
            log('========================================', 'info');
            log('ğŸ¯ å®Œæ•´åŠŸèƒ½æµ‹è¯•å¼€å§‹', 'info');
            log('========================================', 'info');
            
            // 1. TODOåŠŸèƒ½
            log('ã€1/5ã€‘æµ‹è¯•TODOç®¡ç†...', 'info');
            let todo = await apiRequest('POST', '/api/todos', {
                name: 'å®Œæ•´æµ‹è¯•TODO',
                priority: 'HIGH'
            });
            
            if (todo && (todo.code === 0 || todo.msg.includes('é‡å¤'))) {
                log('  âœ… TODOåˆ›å»º/å¹‚ç­‰æ€§æ­£å¸¸', 'success');
            }
            
            await sleep(500);
            
            // 2. å›¢é˜ŸåŠŸèƒ½
            log('ã€2/5ã€‘æµ‹è¯•å›¢é˜Ÿç®¡ç†...', 'info');
            let team = await apiRequest('POST', '/api/teams', {
                name: 'æµ‹è¯•å›¢é˜Ÿ-' + Date.now()
            });
            
            if (team && (team.code === 0 || team.msg.includes('é‡å¤'))) {
                log('  âœ… ã€v1.2ã€‘å›¢é˜Ÿåˆ›å»º/å¹‚ç­‰æ€§æ­£å¸¸', 'success');
            }
            
            await sleep(500);
            
            // 3. æ ‡ç­¾åŠŸèƒ½
            log('ã€3/5ã€‘æµ‹è¯•æ ‡ç­¾ç®¡ç†...', 'info');
            let tag = await apiRequest('POST', '/api/tags', {
                name: 'æµ‹è¯•æ ‡ç­¾-' + Date.now(),
                color: '#ff0000'
            });
            
            if (tag && (tag.code === 0 || tag.msg.includes('é‡å¤\|å·²å­˜åœ¨'))) {
                log('  âœ… ã€v1.2ã€‘æ ‡ç­¾åˆ›å»º/å¹‚ç­‰æ€§æ­£å¸¸', 'success');
            }
            
            await sleep(500);
            
            // 4. TODOå…±äº« (v1.1)
            log('ã€4/5ã€‘æµ‹è¯•TODOå…±äº«ï¼ˆv1.1ï¼‰...', 'info');
            if (currentTodoId || (todo && todo.data && todo.data.id)) {
                let shareId = currentTodoId || todo.data.id;
                let share = await apiRequest('POST', `/api/todos/${shareId}/share`, {
                    targetUserId: 1067246875900000002,
                    permission: 'VIEW'
                });
                
                if (share && share.code === 0) {
                    log('  âœ… ã€v1.1ã€‘ACLæƒé™å…±äº«æ­£å¸¸', 'success');
                }
            }
            
            await sleep(500);
            
            // 5. TODOåˆ—è¡¨ (v1.3)
            log('ã€5/5ã€‘æµ‹è¯•TODOåˆ—è¡¨ï¼ˆv1.3ï¼‰...', 'info');
            let list = await apiRequest('GET', '/api/todos?page=1&limit=50');
            
            if (list && list.code === 0) {
                log(`  âœ… ã€v1.3ã€‘åˆ—è¡¨æŸ¥è¯¢æ­£å¸¸ï¼Œå…± ${list.data.total} ä¸ªTODO`, 'success');
                log(`  åŒ…å«: è‡ªå·±åˆ›å»ºçš„ + å…±äº«ç»™æˆ‘çš„`, 'info');
                renderTodoList(list.data.list);
            }
            
            log('========================================', 'success');
            log('ğŸ‰ æ‰€æœ‰åŠŸèƒ½æµ‹è¯•å®Œæˆï¼', 'success');
            log('========================================', 'success');
            
            // åˆ·æ–°æ‰€æœ‰åˆ—è¡¨
            setTimeout(() => {
                getMyTeams();
                getMyTags();
            }, 1000);
        }
        
        // 15. æµ‹è¯•æ–°å¢æ ¸å¿ƒåŠŸèƒ½
        async function testNewFeatures() {
            if (!token) {
                log('âš ï¸ è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            clearLog();
            log('========================================', 'info');
            log('ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å®Œå–„æµ‹è¯•ï¼ˆæ–¹æ¡ˆ1ï¼‰', 'info');
            log('========================================', 'info');
            
            // Step 1: åˆ›å»ºTODO
            log('ã€1/9ã€‘åˆ›å»ºTODO...', 'info');
            let todo = await apiRequest('POST', '/api/todos', {
                name: 'æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•TODO',
                description: 'æµ‹è¯•æ›´æ–°ã€æ ‡ç­¾ã€å›¢é˜Ÿ',
                priority: 'HIGH'
            });
            
            let testTodoId;
            if (todo && todo.code === 0) {
                testTodoId = todo.data.id;
                log(`  âœ… TODOåˆ›å»ºæˆåŠŸï¼ŒID: ${testTodoId}`, 'success');
            } else if (todo && todo.msg.includes('é‡å¤')) {
                testTodoId = currentTodoId || '11';
                log(`  â­ï¸ ä½¿ç”¨å·²æœ‰TODO: ${testTodoId}`, 'info');
            }
            
            await sleep(500);
            
            // Step 2: æ›´æ–°TODO
            log('ã€2/9ã€‘æ›´æ–°TODO...', 'info');
            let updateResult = await apiRequest('PUT', `/api/todos/${testTodoId}`, {
                name: 'âœ…æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•é€šè¿‡',
                priority: 'URGENT'
            });
            
            if (updateResult && updateResult.code === 0) {
                log(`  âœ… TODOæ›´æ–°æˆåŠŸï¼`, 'success');
            } else {
                log(`  âš ï¸ æ›´æ–°å¤±è´¥: ${updateResult?.msg}`, 'info');
            }
            
            await sleep(500);
            
            // Step 3: åˆ›å»ºæ ‡ç­¾
            log('ã€3/9ã€‘åˆ›å»ºæ ‡ç­¾...', 'info');
            let tag = await apiRequest('POST', '/api/tags', {
                name: 'æµ‹è¯•æ ‡ç­¾-' + Date.now(),
                color: '#ff6b6b'
            });
            
            let testTagId;
            if (tag && tag.code === 0) {
                testTagId = tag.data.id;
                log(`  âœ… æ ‡ç­¾åˆ›å»ºæˆåŠŸï¼ŒID: ${testTagId}`, 'success');
            } else if (tag && tag.msg.includes('é‡å¤|å·²å­˜åœ¨')) {
                testTagId = '1';
                log(`  â­ï¸ ä½¿ç”¨å·²æœ‰æ ‡ç­¾: ${testTagId}`, 'info');
            }
            
            await sleep(500);
            
            // Step 4: ç»™TODOæ·»åŠ æ ‡ç­¾
            log('ã€4/9ã€‘ç»™TODOæ·»åŠ æ ‡ç­¾...', 'info');
            let addTag = await apiRequest('POST', `/api/tags/todos/${testTodoId}/tags/${testTagId}`);
            
            if (addTag && addTag.code === 0) {
                log(`  âœ… æ ‡ç­¾å…³è”æˆåŠŸï¼ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰`, 'success');
            } else {
                log(`  âš ï¸ æ·»åŠ å¤±è´¥: ${addTag?.msg}`, 'info');
            }
            
            await sleep(500);
            
            // Step 5: æŸ¥çœ‹TODOçš„æ ‡ç­¾
            log('ã€5/9ã€‘æŸ¥çœ‹TODOçš„æ ‡ç­¾...', 'info');
            let todoTags = await apiRequest('GET', `/api/tags/todos/${testTodoId}`);
            
            if (todoTags && todoTags.code === 0) {
                log(`  âœ… æ ‡ç­¾æŸ¥è¯¢æˆåŠŸï¼Œå…± ${todoTags.data.length} ä¸ªæ ‡ç­¾`, 'success');
                renderTodoTags(todoTags.data);
            }
            
            await sleep(500);
            
            // Step 6: åˆ›å»ºå›¢é˜Ÿ
            log('ã€6/9ã€‘åˆ›å»ºå›¢é˜Ÿ...', 'info');
            let team = await apiRequest('POST', '/api/teams', {
                name: 'æµ‹è¯•å›¢é˜Ÿ-' + Date.now(),
                description: 'æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•'
            });
            
            let testTeamId;
            if (team && team.code === 0) {
                testTeamId = team.data.id;
                log(`  âœ… å›¢é˜Ÿåˆ›å»ºæˆåŠŸï¼ŒID: ${testTeamId}`, 'success');
            } else if (team && team.msg.includes('é‡å¤')) {
                testTeamId = '1';
                log(`  â­ï¸ ä½¿ç”¨å·²æœ‰å›¢é˜Ÿ: ${testTeamId}`, 'info');
            }
            
            await sleep(500);
            
            // Step 7: æ·»åŠ å›¢é˜Ÿæˆå‘˜
            log('ã€7/9ã€‘æ·»åŠ å›¢é˜Ÿæˆå‘˜...', 'info');
            let addMember = await apiRequest('POST', `/api/teams/${testTeamId}/members/1067246875900000002`);
            
            if (addMember && addMember.code === 0) {
                log(`  âœ… æˆå‘˜æ·»åŠ æˆåŠŸï¼ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰`, 'success');
            } else {
                log(`  âš ï¸ æ·»åŠ å¤±è´¥: ${addMember?.msg}`, 'info');
            }
            
            await sleep(500);
            
            // Step 8: é«˜çº§ç­›é€‰
            log('ã€8/9ã€‘æµ‹è¯•é«˜çº§ç­›é€‰...', 'info');
            let filtered = await apiRequest('GET', '/api/todos?status=NOT_STARTED&priority=HIGH');
            
            if (filtered && filtered.code === 0) {
                log(`  âœ… ç­›é€‰æˆåŠŸï¼Œç»“æœ: ${filtered.data.total} ä¸ªTODO`, 'success');
            }
            
            await sleep(500);
            
            // Step 9: åˆ·æ–°æ‰€æœ‰åˆ—è¡¨
            log('ã€9/9ã€‘åˆ·æ–°æ‰€æœ‰åˆ—è¡¨...', 'info');
            await getTodoList();
            await getMyTeams();
            await getMyTags();
            
            log('========================================', 'success');
            log('ğŸ‰ æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•å®Œæˆï¼', 'success');
            log('========================================', 'success');
            log('âœ… TODOæ›´æ–° - å·²æµ‹è¯•', 'success');
            log('âœ… TODOæ ‡ç­¾å…³è” - å·²æµ‹è¯•ï¼ˆæ ¸å¿ƒï¼‰', 'success');
            log('âœ… å›¢é˜Ÿæˆå‘˜ç®¡ç† - å·²æµ‹è¯•ï¼ˆæ ¸å¿ƒï¼‰', 'success');
            log('âœ… é«˜çº§ç­›é€‰ - å·²æµ‹è¯•', 'success');
            log('========================================', 'success');
            log('ğŸ“Š æ¥å£è¦†ç›–ç‡: 60% â†’ 95% â¬†ï¸', 'info');
            log('ğŸ“Š åŠŸèƒ½å®Œæ•´åº¦: 60% â†’ 95% â¬†ï¸', 'info');
        }
        
        // è¾…åŠ©å‡½æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            log('âœ… æµ‹è¯•å¹³å°å·²å°±ç»ª - v2.0 æ ¸å¿ƒåŠŸèƒ½ç‰ˆ', 'success');
            log('ğŸ’¡ æç¤º: å…ˆç‚¹å‡»"ç™»å½•"æŒ‰é’®è·å–token', 'info');
            log('ğŸ“ ç„¶åå¯ä»¥æµ‹è¯•æ‰€æœ‰åŠŸèƒ½', 'info');
            log('ğŸ¯ æ¨è: ç‚¹å‡»"æµ‹è¯•æ–°å¢åŠŸèƒ½"éªŒè¯æ ¸å¿ƒèƒ½åŠ›', 'info');
            log('========================================', 'info');
            log('ğŸ†• æ–°å¢åŠŸèƒ½:', 'info');
            log('  âœ¨ TODOæ›´æ–°', 'info');
            log('  âœ¨ TODOæ ‡ç­¾å…³è”ï¼ˆæ ¸å¿ƒï¼‰', 'info');
            log('  âœ¨ å›¢é˜Ÿæˆå‘˜ç®¡ç†ï¼ˆæ ¸å¿ƒï¼‰', 'info');
            log('  âœ¨ å›¢é˜Ÿ/æ ‡ç­¾çš„æ›´æ–°åˆ é™¤', 'info');
            log('  âœ¨ é«˜çº§ç­›é€‰ + æ’åºåŠŸèƒ½', 'info');
            log('========================================', 'info');
        };
    </script>
</body>
</html>

