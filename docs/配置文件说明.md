# 配置文件说明

## 配置文件结构

### API服务 (collabtask-api)

```
src/main/resources/
├── bootstrap.yml              # Bootstrap配置（Nacos注册中心）
├── application.yml            # 主配置文件（公共配置）
├── application-dev.yml        # 开发环境配置
├── application-test.yml       # 测试环境配置
└── application-prod.yml       # 生产环境配置
```

### Gateway网关 (collabtask-gateway)

```
src/main/resources/
├── bootstrap.yml              # Bootstrap配置（Nacos注册中心）
├── application.yml            # 主配置文件（路由规则、认证配置）
├── application-dev.yml        # 开发环境配置
├── application-test.yml       # 测试环境配置
└── application-prod.yml       # 生产环境配置
```

## 配置层次说明

### 1. bootstrap.yml
- **加载时机**：最早加载，在application.yml之前
- **主要用途**：配置Nacos注册中心
- **内容**：应用名称、Nacos服务地址、命名空间

### 2. application.yml
- **加载时机**：Bootstrap之后加载
- **主要用途**：公共配置，所有环境共享
- **内容**：
  - API服务：服务器端口、MyBatis配置、Jackson配置等
  - Gateway：路由规则、跨域配置、认证配置

### 3. application-{profile}.yml
- **加载时机**：根据激活的profile加载
- **主要用途**：环境特定配置
- **内容**：
  - API服务：数据库连接、Redis配置
  - Gateway：环境相关的日志级别

## Nacos集成说明

### 当前方案：仅使用注册中心

- ✅ **注册中心**：所有服务注册到Nacos，支持服务发现、负载均衡
- ❌ **配置中心**：由于兼容性问题，暂不使用，配置全部本地管理

### 为什么不使用配置中心？

**问题原因**：Spring Boot 3.5.4 与 Spring Cloud Alibaba 2023.0.3.2 的配置中心模块存在兼容性问题。

**解决方案**：
1. 暂时使用本地配置文件（不影响任何功能）
2. 等待Spring Cloud Alibaba发布兼容版本后再迁移
3. 或降级Spring Boot到3.4.x版本

## 配置文件修改规则

### 修改通用配置
编辑 `application.yml`，修改后需要重启服务

### 修改环境配置
编辑对应的 `application-{profile}.yml`：
- `application-dev.yml` - 开发环境
- `application-test.yml` - 测试环境
- `application-prod.yml` - 生产环境

### 切换环境
修改 `bootstrap.yml` 中的 `spring.profiles.active`

## 配置优先级

加载顺序（后者覆盖前者）：
1. `bootstrap.yml`
2. `application.yml`
3. `application-{profile}.yml`

## Gateway路由配置

### 路由规则说明

```yaml
routes:
  - id: collabtask-api           # 路由ID（唯一）
    uri: lb://collabtask-api     # 目标服务（lb代表负载均衡）
    predicates:                  # 路由断言
      - Path=/api/**             # 匹配路径
    filters:                     # 过滤器
      - StripPrefix=1            # 去除路径前缀（去掉/api）
```

### 认证白名单

在 `application.yml` 中配置不需要认证的URL：

```yaml
gateway:
  auth:
    skip-urls:
      - /api/login      # 登录接口
      - /api/register   # 注册接口
      - /api/captcha    # 验证码接口
```

## 数据库配置

### 开发环境 (application-dev.yml)

```yaml
spring:
  datasource:
    druid:
      url: jdbc:mysql://localhost:3306/collabtask
      username: root
      password: Y9!8nIeRH@163
```

### 生产环境 (application-prod.yml)

**⚠️ 注意**：生产环境密码需要修改为实际密码！

## 日志配置

日志配置在 `logback-spring.xml` 中统一管理，所有服务日志输出到：
- **控制台**：彩色日志，便于开发调试
- **文件**：`/Users/zgy/logs/{application-name}/`

## 配置检查清单

### 首次部署
- [ ] 修改数据库连接信息
- [ ] 修改Redis连接信息
- [ ] 修改Nacos服务地址
- [ ] 修改生产环境密码
- [ ] 检查日志输出路径

### 环境切换
- [ ] 修改 `spring.profiles.active`
- [ ] 检查对应环境的配置文件
- [ ] 重启服务

### 新增服务
- [ ] 在Gateway中添加路由规则
- [ ] 如需认证，配置白名单
- [ ] 服务注册到Nacos

## 常见问题

### Q1: 配置修改后不生效？
A: 本地配置需要重启服务才能生效。

### Q2: 如何添加新的路由？
A: 在Gateway的 `application.yml` 中添加新的路由规则，重启Gateway。

### Q3: 如何禁用认证？
A: 在Gateway的 `application.yml` 中设置 `gateway.auth.enabled: false`。

### Q4: 数据库连接失败？
A: 检查 `application-dev.yml` 中的数据库配置是否正确。

### Q5: Gateway无法转发到API？
A: 检查API服务是否已启动并注册到Nacos。

## 配置文件版本

当前版本：v1.0  
最后更新：2025-11-06  
更新内容：整理所有配置文件，简化结构，仅保留必要配置

