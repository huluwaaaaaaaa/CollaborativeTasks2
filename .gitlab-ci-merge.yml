# ============================================
# GitLab CI/CD é…ç½® - Mergeè§¦å‘
# 
# å·¥ä½œæµç¨‹ï¼š
# 1. å¼€å‘è€…æäº¤ä»£ç åˆ° dev åˆ†æ”¯
# 2. dev åˆå¹¶åˆ° test åˆ†æ”¯ï¼ˆMerge Requestæˆ–æœ¬åœ°mergeï¼‰
# 3. è‡ªåŠ¨è§¦å‘ï¼šæ‰“åŒ… â†’ æ„å»ºé•œåƒ â†’ æ¨é€Nexus â†’ éƒ¨ç½²
# ============================================

variables:
  # Dockeré…ç½®
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  
  # é¡¹ç›®é…ç½®
  NEXUS_REGISTRY: "localhost:5000"
  PROJECT_DIR: "/workspace"

stages:
  - deploy

# ============================================
# æµ‹è¯•ç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²
# è§¦å‘æ¡ä»¶ï¼šä»£ç åˆå¹¶åˆ° test åˆ†æ”¯
# ============================================
deploy-test:
  stage: deploy
  tags:
    - local
    - docker
  variables:
    ENV: "test"
  script:
    - echo "=========================================="
    - echo "ğŸš€ æµ‹è¯•ç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²"
    - echo "=========================================="
    - echo "è§¦å‘åˆ†æ”¯: $CI_COMMIT_BRANCH"
    - echo "æäº¤ä½œè€…: $CI_COMMIT_AUTHOR"
    - echo "æäº¤ä¿¡æ¯: $CI_COMMIT_MESSAGE"
    - echo "æäº¤SHA: $CI_COMMIT_SHA"
    - echo "=========================================="
    - echo ""
    
    # è¿›å…¥é¡¹ç›®ç›®å½•
    - cd $PROJECT_DIR
    
    # è°ƒç”¨Makefileæ‰§è¡Œå‘ç‰ˆ
    - echo "ğŸ“¦ å¼€å§‹å‘ç‰ˆæµç¨‹..."
    - make release ENV=test
    
    - echo ""
    - echo "=========================================="
    - echo "âœ… æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
    - echo "=========================================="
    - echo "ğŸŒ è®¿é—®åœ°å€: http://localhost:8001"
    - echo "ğŸ“Š æŸ¥çœ‹æ—¥å¿—: docker logs -f collabtask-api"
    - echo "=========================================="
  rules:
    # è§„åˆ™ï¼šå½“ä»£ç åˆå¹¶åˆ°teståˆ†æ”¯æ—¶è§¦å‘
    - if: '$CI_COMMIT_BRANCH == "test"'
      when: on_success
  environment:
    name: test
    url: http://localhost:8001
  timeout: 10m

# ============================================
# ç”Ÿäº§ç¯å¢ƒæ‰‹åŠ¨éƒ¨ç½²
# è§¦å‘æ¡ä»¶ï¼štest åˆå¹¶åˆ° main åˆ†æ”¯ï¼Œéœ€è¦æ‰‹åŠ¨ç‚¹å‡»
# ============================================
deploy-prod:
  stage: deploy
  tags:
    - local
    - docker
  variables:
    ENV: "prod"
  script:
    - echo "=========================================="
    - echo "ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²"
    - echo "=========================================="
    - echo "è§¦å‘åˆ†æ”¯: $CI_COMMIT_BRANCH"
    - echo "æäº¤ä½œè€…: $CI_COMMIT_AUTHOR"
    - echo "æäº¤ä¿¡æ¯: $CI_COMMIT_MESSAGE"
    - echo "=========================================="
    - echo ""
    
    - cd $PROJECT_DIR
    - echo "ğŸ“¦ å¼€å§‹å‘ç‰ˆæµç¨‹..."
    - make release ENV=prod
    
    - echo ""
    - echo "=========================================="
    - echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
    - echo "=========================================="
    - echo "ğŸŒ è®¿é—®åœ°å€: http://localhost:8001"
    - echo "=========================================="
  rules:
    # è§„åˆ™ï¼šå½“ä»£ç åˆå¹¶åˆ°mainåˆ†æ”¯æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨è§¦å‘
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
  environment:
    name: production
    url: http://localhost:8001
  timeout: 10m

