# ============================================
# GitLab CI/CD ç®€åŒ–é…ç½®
# ç›´æ¥è°ƒç”¨Makefileå‘½ä»¤ï¼Œç®€å•é«˜æ•ˆï¼
# ============================================

variables:
  # ç¯å¢ƒé…ç½®
  DEPLOY_ENV: "test"  # é»˜è®¤æµ‹è¯•ç¯å¢ƒï¼Œå¯ä»¥æ”¹ä¸º prod
  
  # Nexusé…ç½®ï¼ˆéœ€è¦åœ¨GitLab CI/CDå˜é‡ä¸­é…ç½®ï¼‰
  NEXUS_REGISTRY: "${NEXUS_HOST}"  # ä¾‹å¦‚ï¼šnexus.yourcompany.com:5000
  NEXUS_USERNAME: "${NEXUS_USER}"   # ä»GitLabå˜é‡è·å–
  NEXUS_PASSWORD: "${NEXUS_PASS}"   # ä»GitLabå˜é‡è·å–

stages:
  - release

# ============================================
# ğŸš€ ä¸€é”®å‘ç‰ˆï¼ˆè°ƒç”¨Makefileï¼‰
# ============================================
release-to-test:
  stage: release
  image: docker:24
  tags:
    - docker
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    ENV: "test"
  before_script:
    # å®‰è£…å¿…è¦å·¥å…·
    - apk add --no-cache make maven openjdk17
  script:
    # ç›´æ¥è°ƒç”¨Makefileçš„releaseå‘½ä»¤
    - make release ENV=test
  rules:
    # åªåœ¨teståˆ†æ”¯è§¦å‘
    - if: '$CI_COMMIT_BRANCH == "test"'
      when: on_success
  environment:
    name: test
    url: http://your-test-server:8001

# ============================================
# ğŸš€ ç”Ÿäº§ç¯å¢ƒå‘ç‰ˆï¼ˆéœ€æ‰‹åŠ¨è§¦å‘ï¼‰
# ============================================
release-to-prod:
  stage: release
  image: docker:24
  tags:
    - docker
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    ENV: "prod"
  before_script:
    - apk add --no-cache make maven openjdk17
  script:
    - make release ENV=prod
  rules:
    # åªåœ¨mainåˆ†æ”¯æ‰‹åŠ¨è§¦å‘
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
  environment:
    name: production
    url: http://your-prod-server:8001

