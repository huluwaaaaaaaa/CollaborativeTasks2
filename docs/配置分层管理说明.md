# 配置分层管理说明

## 配置分层原则

### 本地配置 vs Nacos配置

| 配置类型 | 放在哪里 | 原因 |
|---------|---------|------|
| 应用名称 | 本地 | 基础信息，不应该改 |
| 服务端口 | 本地 | 基础信息，不应该改 |
| Context-Path | 本地 | 基础信息，影响URL结构 |
| Nacos连接 | 本地 | 必须在本地，否则无法连接Nacos |
| 框架配置 | 本地 | WebFlux、排除自动配置等 |
| **路由规则** | **Nacos** | 动态可调整，无需重启 |
| **跨域配置** | **Nacos** | 可能需要调整 |
| **认证配置** | **Nacos** | 可能需要开关 |
| **数据库配置** | **Nacos** | 敏感信息，环境相关 |
| **Redis配置** | **Nacos** | 环境相关 |
| **日志级别** | **Nacos** | 动态调整 |

## 配置文件结构

### API服务

#### 本地：application.yml
```yaml
# 保留的配置
server:
  port: 8002
  servlet:
    context-path: /collabtask-api

spring:
  application:
    name: collabtask-api
  config:
    import:
      - optional:nacos:collabtask-api.yaml
  cloud:
    nacos:
      server-addr: localhost:8848

mybatis-plus:
  mapper-locations: classpath*:/mapper/**/*.xml
```

#### Nacos：collabtask-api.yaml
```yaml
# 环境相关配置
spring:
  datasource:
    druid:
      url: jdbc:mysql://...
      username: root
      password: xxx
  data:
    redis:
      host: localhost
      port: 6379
```

### Gateway服务

#### 本地：application.yml
```yaml
# 保留的配置
server:
  port: 8001

spring:
  application:
    name: collabtask-gateway
  main:
    web-application-type: reactive
  config:
    import:
      - optional:nacos:collabtask-gateway.yaml
  cloud:
    nacos:
      server-addr: localhost:8848
  autoconfigure:
    exclude:
      - DataSourceAutoConfiguration
```

#### Nacos：collabtask-gateway.yaml
```yaml
# 业务配置（可动态调整）
spring:
  cloud:
    gateway:
      routes:
        - id: collabtask-api
          uri: lb://collabtask-api
          predicates:
            - Path=/api/**
          filters:
            - PrefixPath=/collabtask-api
      
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns: "*"

gateway:
  auth:
    enabled: false
    skip-urls:
      - /api/login
```

## 配置优先级

```
Nacos远程配置 (最高)
    ↓
本地 application-{profile}.yml
    ↓
本地 application.yml
    ↓
bootstrap.yml (最低)
```

## 为什么这样分层？

### 本地配置的优势
- ✅ 应用启动的基础，即使Nacos不可用也能启动（降级）
- ✅ 版本控制，代码仓库可以追踪
- ✅ 新人clone代码后就能看到基础配置

### Nacos配置的优势
- ✅ 集中管理，多个服务共享配置
- ✅ 动态刷新，无需重启
- ✅ 环境隔离，dev/test/prod独立
- ✅ 敏感信息加密，安全
- ✅ 配置历史，可回滚

## 配置修改流程

### 修改本地配置
1. 编辑本地 `application.yml`
2. 提交代码到Git
3. 重启服务

**适用场景**：应用名、端口、框架配置等**不常变**的配置

### 修改Nacos配置
1. 登录Nacos控制台
2. 编辑对应的配置文件
3. 点击"发布"
4. 配置自动刷新（无需重启）

**适用场景**：路由规则、数据库连接、功能开关等**可能调整**的配置

## 最佳实践

### 1. 最小本地配置原则

本地只保留：
- 应用启动必需的配置
- 不会变化的配置
- Nacos连接配置

### 2. Nacos集中管理

把以下配置放Nacos：
- 所有环境相关配置
- 所有可能调整的配置
- 所有敏感信息

### 3. 配置降级

即使Nacos不可用，应用也应该能启动（使用本地默认配置）：
```yaml
spring:
  config:
    import:
      - optional:nacos:xxx.yaml  # optional很重要！
```

## 配置文件对比

### 精简前（本地配置很多）

**application.yml**：120行
- 包含路由规则
- 包含跨域配置
- 包含认证配置
- 包含所有业务配置

**Nacos配置**：基本为空

**问题**：
- 配置修改需要重启
- 不同环境需要维护多个配置文件
- 敏感信息暴露在代码中

### 精简后（推荐）

**本地 application.yml**：60行
- 只包含基础配置
- 只包含Nacos连接
- 框架配置

**Nacos配置**：80行
- 所有路由规则
- 跨域配置
- 认证配置
- 环境相关配置

**优势**：
- ✅ 配置修改无需重启
- ✅ 环境隔离清晰
- ✅ 敏感信息在Nacos加密
- ✅ 本地配置简洁

## 推荐的配置方案

### Gateway本地配置（精简版）

```yaml
server:
  port: 8001

spring:
  application:
    name: collabtask-gateway
  main:
    web-application-type: reactive
  config:
    import:
      - optional:nacos:collabtask-gateway.yaml?group=DEFAULT_GROUP&refreshEnabled=true
  cloud:
    nacos:
      server-addr: ${NACOS_HOST:localhost}:${NACOS_PORT:8848}
      username: ${NACOS_USERNAME:nacos}
      password: ${NACOS_PASSWORD:nacos}
      config:
        namespace: ${NACOS_NAMESPACE:dev}
        group: DEFAULT_GROUP
      discovery:
        namespace: ${NACOS_NAMESPACE:dev}
        group: DEFAULT_GROUP
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration
```

### API本地配置（精简版）

```yaml
server:
  port: 8002
  servlet:
    context-path: /collabtask-api

spring:
  application:
    name: collabtask-api
  main:
    allow-circular-references: true
  config:
    import:
      - optional:nacos:collabtask-api.yaml?group=DEFAULT_GROUP&refreshEnabled=true
  cloud:
    nacos:
      server-addr: ${NACOS_HOST:localhost}:${NACOS_PORT:8848}
      config:
        namespace: ${NACOS_NAMESPACE:dev}
      discovery:
        namespace: ${NACOS_NAMESPACE:dev}

mybatis-plus:
  mapper-locations: classpath*:/mapper/**/*.xml
  typeAliasesPackage: io.user.entity
```

## 总结

**是的，应该精简本地配置！**

- 本地：只保留**基础和框架配置**
- Nacos：管理**所有业务和环境配置**

这样的好处：
1. 配置修改无需重启
2. 多环境管理方便
3. 团队协作更清晰
4. 敏感信息更安全

**我已经帮你精简了配置文件，现在本地配置非常简洁！** ✅

