# Nacosé…ç½®ä¸­å¿ƒä¸ç”Ÿæ•ˆ - å®Œæ•´é—®é¢˜åˆ†æ

## é—®é¢˜ç°è±¡

APIæœåŠ¡å¯åŠ¨æ—¶ï¼Œæ•°æ®åº“é…ç½®æ— æ³•åŠ è½½ï¼ŒæŠ¥é”™ï¼š
```
DataSource URL is not set!
```

ä½†æ˜¯ï¼š
- âœ… æœåŠ¡èƒ½æˆåŠŸæ³¨å†Œåˆ°Nacosï¼ˆæ³¨å†Œä¸­å¿ƒå·¥ä½œæ­£å¸¸ï¼‰
- âŒ Nacosé…ç½®ä¸­å¿ƒçš„é…ç½®æ²¡æœ‰è¢«åŠ è½½

## ç¯å¢ƒä¿¡æ¯

### ç‰ˆæœ¬ä¿¡æ¯
- **Spring Boot**: 3.5.4
- **Spring Cloud**: 2024.0.0  
- **Spring Cloud Alibaba**: 2023.0.3.2
- **Nacos Server**: 2.x

### ä¾èµ–é…ç½®
```xml
<!-- Bootstrap -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>

<!-- Nacos Config -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>

<!-- Nacos Discovery -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

## æ ¹æœ¬åŸå› åˆ†æ

### ğŸ¯ æ ¸å¿ƒé—®é¢˜ï¼šé…ç½®ä¸å®Œæ•´

#### é”™è¯¯çš„é…ç½®ï¼ˆä¹‹å‰ï¼‰

```yaml
# bootstrap.yml
spring:
  application:
    name: collabtask-api
  profiles:
    active: dev
  cloud:
    nacos:
      server-addr: localhost:8848
      # âœ… é…ç½®äº†discoveryï¼ˆæ‰€ä»¥æ³¨å†Œä¸­å¿ƒå·¥ä½œï¼‰
      discovery:
        namespace: dev
        group: DEFAULT_GROUP
      # âŒ æ²¡æœ‰é…ç½®configï¼ˆæ‰€ä»¥é…ç½®ä¸­å¿ƒä¸å·¥ä½œï¼‰ï¼
```

**é—®é¢˜åˆ†æ**ï¼š
1. `discovery` é…ç½®å­˜åœ¨ â†’ æ³¨å†Œä¸­å¿ƒåŠŸèƒ½æ­£å¸¸
2. `config` é…ç½®ç¼ºå¤± â†’ é…ç½®ä¸­å¿ƒåŠŸèƒ½æœªå¯ç”¨
3. å¯åŠ¨æ—¥å¿—ä¸­æ²¡æœ‰ `Located property source` â†’ è¯æ˜é…ç½®æœªåŠ è½½

### ğŸ” ä¸ºä»€ä¹ˆæ³¨å†Œä¸­å¿ƒèƒ½å·¥ä½œï¼Œé…ç½®ä¸­å¿ƒä¸å·¥ä½œï¼Ÿ

Nacosçš„ä¸¤ä¸ªåŠŸèƒ½æ˜¯**ç‹¬ç«‹çš„**ï¼š

| åŠŸèƒ½ | é…ç½®è·¯å¾„ | ä½œç”¨ | ä¾èµ– |
|------|---------|------|------|
| æ³¨å†Œä¸­å¿ƒ | `spring.cloud.nacos.discovery` | æœåŠ¡æ³¨å†Œä¸å‘ç° | `spring-cloud-starter-alibaba-nacos-discovery` |
| é…ç½®ä¸­å¿ƒ | `spring.cloud.nacos.config` | é…ç½®é›†ä¸­ç®¡ç† | `spring-cloud-starter-alibaba-nacos-config` |

**å³ä½¿å¼•å…¥äº†ä¸¤ä¸ªä¾èµ–ï¼Œå¦‚æœä¸åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼ŒåŠŸèƒ½ä¹Ÿä¸ä¼šå¯ç”¨ï¼**

## å®Œæ•´æ’æŸ¥è¿‡ç¨‹

### ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥å¯åŠ¨æ—¥å¿—

#### æ­£å¸¸æƒ…å†µï¼ˆé…ç½®ä¸­å¿ƒå·¥ä½œï¼‰
```log
Located property source: [BootstrapPropertySource {name='bootstrapProperties-collabtask-api.yaml,DEFAULT_GROUP'}]
Nacos config refreshed successfully
```

#### å¼‚å¸¸æƒ…å†µï¼ˆé…ç½®ä¸­å¿ƒä¸å·¥ä½œï¼‰
```log
# åªæœ‰æ³¨å†Œç›¸å…³æ—¥å¿—
Nacos registry, DEFAULT_GROUP collabtask-api 192.168.1.1:8002 register finished

# æ²¡æœ‰é…ç½®åŠ è½½æ—¥å¿—
# æ²¡æœ‰ "Located property source"
# æ²¡æœ‰ "config refreshed"
```

### ç¬¬äºŒæ­¥ï¼šåˆ†ææ—¥å¿—å·®å¼‚

| æ—¥å¿—å…³é”®å­— | è¯´æ˜ | å‡ºç°æƒ…å†µ |
|-----------|------|----------|
| `Located property source` | é…ç½®åŠ è½½æˆåŠŸ | åªåœ¨configé…ç½®æ­£ç¡®æ—¶å‡ºç° |
| `NacosConfigBootstrapConfiguration` | Configæ¨¡å—åˆå§‹åŒ– | åªåœ¨configé…ç½®æ­£ç¡®æ—¶å‡ºç° |
| `NacosServiceRegistry` | æ³¨å†Œä¸­å¿ƒåˆå§‹åŒ– | discoveryé…ç½®æ­£ç¡®å°±å‡ºç° |

**ç»“è®º**ï¼šå®Œå…¨æ²¡æœ‰é…ç½®ä¸­å¿ƒç›¸å…³æ—¥å¿— â†’ configé…ç½®ç¼ºå¤±

### ç¬¬ä¸‰æ­¥ï¼šå¯¹æ¯”æ­£ç¡®é…ç½®

#### Spring Cloud Alibabaå®˜æ–¹æ–‡æ¡£ç¤ºä¾‹

```yaml
spring:
  cloud:
    nacos:
      config:                          # â­ å¿…é¡»é…ç½®
        server-addr: 127.0.0.1:8848
        file-extension: yaml
      discovery:                       # â­ ç‹¬ç«‹é…ç½®
        server-addr: 127.0.0.1:8848
```

#### æˆ‘ä»¬ä¹‹å‰çš„é…ç½®

```yaml
spring:
  cloud:
    nacos:
      server-addr: localhost:8848      # å…±ç”¨server-addr
      discovery:                       # âœ… æœ‰discovery
        namespace: dev
        group: DEFAULT_GROUP
      # âŒ ç¼ºå°‘configé…ç½®ï¼
```

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šæ·»åŠ configé…ç½®ï¼ˆæ¨èï¼‰

```yaml
spring:
  application:
    name: collabtask-api
  profiles:
    active: dev
  cloud:
    nacos:
      server-addr: localhost:8848
      
      # â­ æ–°å¢ï¼šé…ç½®ä¸­å¿ƒé…ç½®
      config:
        namespace: dev                    
        group: DEFAULT_GROUP              
        file-extension: yaml              
        refresh-enabled: true             
        name: ${spring.application.name}
      
      # âœ… ä¿ç•™ï¼šæ³¨å†Œä¸­å¿ƒé…ç½®
      discovery:
        namespace: dev
        group: DEFAULT_GROUP
```

### æ–¹æ¡ˆäºŒï¼šåœ¨Nacosåˆ›å»ºé…ç½®

1. **ç™»å½•Nacosæ§åˆ¶å°**ï¼šhttp://localhost:8848/nacos

2. **åˆ›å»ºå‘½åç©ºé—´**ï¼š
   - å‘½åç©ºé—´IDï¼š`dev`
   - å‘½åç©ºé—´åï¼š`å¼€å‘ç¯å¢ƒ`

3. **åˆ›å»ºé…ç½®**ï¼š
   - å‘½åç©ºé—´ï¼š`dev`
   - Data IDï¼š`collabtask-api.yaml`
   - Groupï¼š`DEFAULT_GROUP`
   - é…ç½®å†…å®¹ï¼š
   ```yaml
   spring:
     datasource:
       druid:
         url: jdbc:mysql://localhost:3306/collabtask
         username: root
         password: your_password
   ```

### æ–¹æ¡ˆä¸‰ï¼šæ¸…ç©ºæœ¬åœ°é…ç½®

ä¸ºç¡®ä¿ä»NacosåŠ è½½ï¼Œæ¸…ç©º `application-dev.yml`ï¼š

```yaml
# å¼€å‘ç¯å¢ƒé…ç½®å·²è¿ç§»åˆ°Nacos
# é…ç½®ä½ç½®ï¼šNacosæ§åˆ¶å° -> devå‘½åç©ºé—´ -> collabtask-api.yaml
```

## éªŒè¯æ­¥éª¤

### 1. é‡å¯æœåŠ¡

```bash
cd collabtask-api
mvn spring-boot:run
```

### 2. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—

**æˆåŠŸæ ‡å¿—**ï¼š
```log
[main] INFO  c.a.c.n.c.NacosConfigBootstrapConfiguration - Located property source: [BootstrapPropertySource {name='bootstrapProperties-collabtask-api.yaml,DEFAULT_GROUP'}]

[main] INFO  io.user.ApiApplication - Started ApiApplication in 5.123 seconds
```

### 3. éªŒè¯æ•°æ®åº“è¿æ¥

çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—è¯´æ˜é…ç½®åŠ è½½æˆåŠŸï¼š
```log
[main] INFO  com.alibaba.druid.pool.DruidDataSource - {dataSource-1} inited
[main] INFO  org.apache.catalina.core.StandardService - Starting service [Tomcat]
```

## ä¸ºä»€ä¹ˆä¹‹å‰çš„æ–¹æ¡ˆéƒ½æ²¡ç”¨ï¼Ÿ

### å°è¯•è¿‡çš„æ–¹æ¡ˆå›é¡¾

| å°è¯•æ–¹æ¡ˆ | ç»“æœ | åŸå› åˆ†æ |
|---------|------|----------|
| è°ƒæ•´ä¾èµ–é¡ºåº | âŒ æ— æ•ˆ | æ ¹æœ¬é—®é¢˜æ˜¯é…ç½®ç¼ºå¤±ï¼Œä¸æ˜¯ä¾èµ–é—®é¢˜ |
| ä¿®æ”¹Data ID | âŒ æ— æ•ˆ | é…ç½®æ²¡å¯ç”¨ï¼ŒData IDå†å¯¹ä¹Ÿæ²¡ç”¨ |
| æ·»åŠ spring.factories | âŒ æ— æ•ˆ | Bootstrapå·²æœ‰é…ç½®ï¼Œä¸æ˜¯åŠ è½½é¡ºåºé—®é¢˜ |
| ä½¿ç”¨@Lazyæ³¨è§£ | âŒ æ— æ•ˆ | æ•°æ®åº“é…ç½®æœ¬èº«å°±ä¸å­˜åœ¨ |
| æ·»åŠ spring.config.import | âŒ æ— æ•ˆ | æ–°ç‰ˆé…ç½®æ–¹å¼ï¼Œä½†configé…ç½®è¿˜æ˜¯è¦æœ‰ |

**ç»“è®º**ï¼šè¿™äº›éƒ½æ˜¯åœ¨"é…ç½®ä¸­å¿ƒå·²å¯ç”¨"å‰æä¸‹çš„ä¼˜åŒ–ï¼Œä½†æˆ‘ä»¬çš„é—®é¢˜æ˜¯é…ç½®ä¸­å¿ƒæ ¹æœ¬æ²¡å¯ç”¨ï¼

## æ·±å±‚åŸå› åˆ†æ

### Spring Cloud Alibabaå¯åŠ¨æµç¨‹

```
1. Spring Bootå¯åŠ¨
   â†“
2. åŠ è½½bootstrap.yml
   â†“
3. æ£€æŸ¥æ˜¯å¦æœ‰spring.cloud.nacosé…ç½®
   â†“
4. åˆ†åˆ«åˆå§‹åŒ–discoveryå’Œconfigæ¨¡å—
   â”œâ”€â†’ discoveryå­˜åœ¨ â†’ åˆå§‹åŒ–NacosServiceRegistry
   â””â”€â†’ configå­˜åœ¨ â†’ åˆå§‹åŒ–NacosConfigBootstrapConfiguration
        â†“
        åŠ è½½è¿œç¨‹é…ç½®
```

**å…³é”®ç‚¹**ï¼š
- Discoveryå’ŒConfigæ˜¯**ç‹¬ç«‹åˆå§‹åŒ–**çš„
- åªé…ç½®Discoveryï¼ŒConfigæ¨¡å—**ä¸ä¼šè‡ªåŠ¨å¯ç”¨**
- å¿…é¡»æ˜ç¡®é…ç½® `spring.cloud.nacos.config`

### ä»£ç å±‚é¢åˆ†æ

Spring Cloud Alibabaçš„è‡ªåŠ¨é…ç½®æ¡ä»¶ï¼š

```java
@ConditionalOnProperty(name = "spring.cloud.nacos.config.enabled", 
                       matchIfMissing = true)
public class NacosConfigAutoConfiguration {
    // Configç›¸å…³é…ç½®
}
```

è™½ç„¶ `matchIfMissing = true`ï¼ˆé»˜è®¤å¯ç”¨ï¼‰ï¼Œä½†è¿˜éœ€è¦ï¼š
```java
@ConditionalOnBean(NacosConfigProperties.class)
```

è€Œ `NacosConfigProperties` åªæœ‰åœ¨é…ç½®äº† `spring.cloud.nacos.config` æ—¶æ‰ä¼šåˆ›å»ºï¼

## ç»éªŒæ•™è®­

### 1. é˜…è¯»å®˜æ–¹æ–‡æ¡£çš„é‡è¦æ€§

Spring Cloud Alibabaå®˜æ–¹æ–‡æ¡£æ˜ç¡®å†™æ˜ï¼š

```yaml
# é…ç½®ä¸­å¿ƒ
spring.cloud.nacos.config.server-addr=localhost:8848

# æœåŠ¡å‘ç°
spring.cloud.nacos.discovery.server-addr=localhost:8848
```

**ä¸¤è€…æ˜¯ç‹¬ç«‹çš„ï¼Œä¸èƒ½çœç•¥ï¼**

### 2. æ—¥å¿—åˆ†æçš„é‡è¦æ€§

å…³é”®æ—¥å¿—ï¼š
- `Located property source` â†’ é…ç½®åŠ è½½æˆåŠŸ
- `NacosConfigBootstrapConfiguration` â†’ Configåˆå§‹åŒ–

å¦‚æœå¯åŠ¨æ—¥å¿—ä¸­æ²¡æœ‰è¿™äº›ï¼Œè¯´æ˜Configæœªå¯ç”¨ã€‚

### 3. ä¸è¦è¿‡åº¦ä¼˜åŒ–

é—®é¢˜å®šä½æ—¶åº”è¯¥ï¼š
1. å…ˆç¡®è®¤åŠŸèƒ½æ˜¯å¦å¯ç”¨ï¼ˆconfigé…ç½®æ˜¯å¦å­˜åœ¨ï¼‰
2. å†æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®ï¼ˆData IDã€å‘½åç©ºé—´ç­‰ï¼‰
3. æœ€åæ‰è€ƒè™‘é«˜çº§é—®é¢˜ï¼ˆä¾èµ–å†²çªã€ç‰ˆæœ¬å…¼å®¹ç­‰ï¼‰

## æ€»ç»“

### é—®é¢˜æœ¬è´¨

**é…ç½®ä¸­å¿ƒä¸ç”Ÿæ•ˆçš„æ ¹æœ¬åŸå› **ï¼š
- âŒ `bootstrap.yml` ä¸­ç¼ºå°‘ `spring.cloud.nacos.config` é…ç½®
- âœ… åªé…ç½®äº† `spring.cloud.nacos.discovery`

### è§£å†³æ–¹æ³•

1. **åœ¨bootstrap.ymlæ·»åŠ configé…ç½®**
2. **åœ¨Nacosåˆ›å»ºå¯¹åº”çš„é…ç½®æ–‡ä»¶**
3. **æ¸…ç©ºæœ¬åœ°ç¯å¢ƒé…ç½®é¿å…å†²çª**

### éªŒè¯æ ‡å‡†

å¯åŠ¨æ—¥å¿—ä¸­å‡ºç°ï¼š
```
Located property source: [BootstrapPropertySource {name='bootstrapProperties-xxx.yaml'}]
```

è¯´æ˜é…ç½®ä¸­å¿ƒå·²æˆåŠŸå¯ç”¨å¹¶åŠ è½½é…ç½®ï¼

### é€‚ç”¨åœºæ™¯

è¿™ä¸ªé—®é¢˜çš„åˆ†ææ–¹æ³•é€‚ç”¨äºï¼š
- âœ… Nacosé…ç½®ä¸­å¿ƒä¸ç”Ÿæ•ˆ
- âœ… Spring Cloud Configä¸ç”Ÿæ•ˆ
- âœ… ä»»ä½•åŸºäºBootstrapçš„é…ç½®ä¸­å¿ƒ

**æ ¸å¿ƒæ€è·¯**ï¼šå…ˆç¡®è®¤åŠŸèƒ½æ˜¯å¦å¯ç”¨ï¼Œå†æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®ï¼

---

**è®°ä½è¿™ä¸ªæ•™è®­ï¼šé…ç½®ä¸­å¿ƒè¦ç”Ÿæ•ˆï¼Œdiscoveryå’Œconfigç¼ºä¸€ä¸å¯ï¼** ğŸ¯

