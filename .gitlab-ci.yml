# ============================================
# GitLab CI/CD Pipeline 配置
# ============================================

variables:
  # Maven配置
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  
  # Nexus私服配置
  NEXUS_REGISTRY: "localhost:5000"  # Docker Registry端口
  NEXUS_MAVEN_REPO: "http://localhost:8081/repository/maven-public/"  # Maven仓库
  
  # Docker镜像配置
  API_IMAGE: "${NEXUS_REGISTRY}/collabtask-api"
  GATEWAY_IMAGE: "${NEXUS_REGISTRY}/collabtask-gateway"
  
  # 版本号
  VERSION: "${CI_COMMIT_SHORT_SHA}"

# 定义阶段
stages:
  - build
  - test
  - docker-build
  - deploy

# Maven缓存
cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - .m2/repository/
    - collabtask-api/target/
    - collabtask-gateway/target/
    - collabtask-common/target/
    - collabtask-dynamic-datasource/target/

# ============================================
# 阶段1：编译
# ============================================
maven-build:
  stage: build
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "==> 开始Maven编译..."
    # 配置Nexus Maven仓库
    - mkdir -p ~/.m2
    - |
      cat > ~/.m2/settings.xml << EOF
      <settings>
        <mirrors>
          <mirror>
            <id>nexus</id>
            <mirrorOf>*</mirrorOf>
            <url>${NEXUS_MAVEN_REPO}</url>
          </mirror>
        </mirrors>
      </settings>
      EOF
    - mvn clean package -DskipTests
    - echo "==> Maven编译完成"
  artifacts:
    paths:
      - collabtask-api/target/*.jar
      - collabtask-gateway/target/*.jar
    expire_in: 1 day
  only:
    - main
    - develop
    - test
    - merge_requests

# ============================================
# 阶段2：测试
# ============================================
unit-test:
  stage: test
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "==> 运行单元测试..."
    - mvn test
    - echo "==> 单元测试完成"
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    when: always
    reports:
      junit:
        - "**/target/surefire-reports/TEST-*.xml"
    paths:
      - "**/target/site/jacoco/"
    expire_in: 7 days
  only:
    - main
    - develop
    - test
    - merge_requests

# 代码质量检查
code-quality:
  stage: test
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "==> 代码质量检查..."
    - mvn checkstyle:check || true
    - mvn pmd:check || true
  allow_failure: true
  only:
    - main
    - develop
    - test
    - merge_requests

# ============================================
# 阶段3：构建Docker镜像
# ============================================
docker-build-api:
  stage: docker-build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    # 登录Nexus Docker Registry
    - echo ${NEXUS_PASSWORD} | docker login ${NEXUS_REGISTRY} -u ${NEXUS_USERNAME} --password-stdin
  script:
    - echo "==> 构建API镜像..."
    - docker build -f collabtask-api/Dockerfile -t ${API_IMAGE}:${VERSION} -t ${API_IMAGE}:latest .
    - echo "==> 推送镜像到Nexus..."
    - docker push ${API_IMAGE}:${VERSION}
    - docker push ${API_IMAGE}:latest
    - echo "==> API镜像构建完成: ${API_IMAGE}:${VERSION}"
  only:
    - main
    - develop
    - test
  dependencies:
    - maven-build

docker-build-gateway:
  stage: docker-build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - echo ${NEXUS_PASSWORD} | docker login ${NEXUS_REGISTRY} -u ${NEXUS_USERNAME} --password-stdin
  script:
    - echo "==> 构建Gateway镜像..."
    - docker build -f collabtask-gateway/Dockerfile -t ${GATEWAY_IMAGE}:${VERSION} -t ${GATEWAY_IMAGE}:latest .
    - echo "==> 推送镜像到Nexus..."
    - docker push ${GATEWAY_IMAGE}:${VERSION}
    - docker push ${GATEWAY_IMAGE}:latest
    - echo "==> Gateway镜像构建完成: ${GATEWAY_IMAGE}:${VERSION}"
  only:
    - main
    - develop
    - test
  dependencies:
    - maven-build

# ============================================
# 阶段4：部署
# ============================================

# 部署到测试环境（test分支自动触发）
deploy-test:
  stage: deploy
  image: docker:24
  before_script:
    - apk add --no-cache curl
  script:
    - echo "==> 部署到测试环境..."
    - echo "==> 使用docker-compose-nexus.yml部署..."
    # 如果有远程测试服务器，使用SSH部署
    # 如果是本地测试，使用docker-compose
    - |
      if [ -n "${TEST_SERVER_HOST}" ]; then
        # SSH到测试服务器部署
        apk add --no-cache openssh-client
        ssh -o StrictHostKeyChecking=no ${TEST_SERVER_USER}@${TEST_SERVER_HOST} << EOF
          cd /opt/collabtask
          echo "==> 拉取最新代码..."
          git pull origin test
          echo "==> 拉取最新镜像..."
          docker login ${NEXUS_REGISTRY} -u ${NEXUS_USERNAME} -p ${NEXUS_PASSWORD}
          docker pull ${API_IMAGE}:latest
          docker pull ${GATEWAY_IMAGE}:latest
          echo "==> 重启服务..."
          docker-compose -f docker-compose-nexus.yml down
          docker-compose -f docker-compose-nexus.yml up -d
          echo "==> 等待服务启动..."
          sleep 30
          docker-compose -f docker-compose-nexus.yml ps
        EOF
      else
        # 本地部署
        echo "==> 本地测试环境部署..."
        echo "请在本地执行: make deploy-local"
      fi
    - echo "==> 测试环境部署完成"
  environment:
    name: test
    url: http://${TEST_SERVER_HOST:-localhost}:8001
  only:
    - test
  when: on_success  # test分支自动触发

# 部署到开发环境
deploy-dev:
  stage: deploy
  image: docker:24
  before_script:
    - apk add --no-cache openssh-client
  script:
    - echo "==> 部署到开发环境..."
    # SSH到目标服务器
    - |
      ssh -o StrictHostKeyChecking=no ${DEV_SERVER_USER}@${DEV_SERVER_HOST} << EOF
        cd /opt/collabtask
        # 停止旧服务
        docker-compose down
        # 拉取最新镜像
        docker pull ${API_IMAGE}:latest
        docker pull ${GATEWAY_IMAGE}:latest
        # 启动新服务
        docker-compose up -d
        # 查看状态
        docker-compose ps
      EOF
    - echo "==> 开发环境部署完成"
  environment:
    name: development
    url: http://${DEV_SERVER_HOST}:8001
  only:
    - develop
  when: manual

# 部署到生产环境
deploy-prod:
  stage: deploy
  image: docker:24
  before_script:
    - apk add --no-cache openssh-client
  script:
    - echo "==> 部署到生产环境..."
    - |
      ssh -o StrictHostKeyChecking=no ${PROD_SERVER_USER}@${PROD_SERVER_HOST} << EOF
        cd /opt/collabtask
        # 停止旧服务
        docker-compose down
        # 拉取指定版本镜像
        docker pull ${API_IMAGE}:${VERSION}
        docker pull ${GATEWAY_IMAGE}:${VERSION}
        # 更新docker-compose.yml中的镜像版本
        sed -i "s|image: .*collabtask-api.*|image: ${API_IMAGE}:${VERSION}|g" docker-compose.yml
        sed -i "s|image: .*collabtask-gateway.*|image: ${GATEWAY_IMAGE}:${VERSION}|g" docker-compose.yml
        # 启动新服务
        docker-compose up -d
        # 健康检查
        sleep 30
        curl -f http://localhost:8001/actuator/health || exit 1
      EOF
    - echo "==> 生产环境部署完成"
  environment:
    name: production
    url: http://${PROD_SERVER_HOST}:8001
  only:
    - main
  when: manual

